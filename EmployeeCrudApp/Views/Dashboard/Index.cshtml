@{
    ViewData["Title"] = "Dashboard";
}

<div class="container mt-4">
    <h1 class="text-center mb-4 text-white">Welcome to Your Dashboard</h1>
    
    <div class="row g-4">
        <!-- Weather Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-primary text-white mb-3 mx-auto">
                        <i class="bi bi-cloud-sun-fill"></i>
                    </div>
                    <h5 class="card-title fw-bold">Weather Details</h5>
                    <div id="weather-content" class="mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="input-group input-group-sm mb-2 shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="location-input" class="form-control border-0 px-3" placeholder="Enter city, town, or country...">
                            <button onclick="updateWeather()" class="btn btn-primary border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <p class="small text-muted mb-0">Try "London", "Tokyo", or "France"</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currency Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-success text-white mb-3 mx-auto">
                        <i class="bi bi-currency-exchange"></i>
                    </div>
                    <h5 class="card-title fw-bold">Currency Conversion</h5>
                    <div class="mt-3">
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text">Amount</span>
                            <input type="number" id="amount" class="form-control" value="1">
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col">
                                <select id="from-currency" class="form-select form-select-sm">
                                    <option value="USD" selected>USD</option>
                                    <!-- Dynamically populated -->
                                </select>
                            </div>
                            <div class="col">
                                <select id="to-currency" class="form-select form-select-sm">
                                    <option value="INR" selected>INR</option>
                                    <!-- Dynamically populated -->
                                </select>
                            </div>
                        </div>
                        <button onclick="convertCurrency()" class="btn btn-success btn-sm w-100 rounded-pill">Convert</button>
                        <div id="currency-result" class="mt-3 fw-bold fs-5"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body text-center p-4">
                    <div class="icon-circle bg-info text-white mb-3 mx-auto">
                        <i class="bi bi-clock-fill"></i>
                    </div>
                    <h5 class="card-title fw-bold">Time Conversion</h5>
                    <div class="mt-3">
                        <div class="mb-2">
                            <label class="form-label small text-muted">Current Local Time:</label>
                            <div id="local-time" class="fw-bold"></div>
                        </div>
                        <div class="mb-3">
                            <select id="timezone-select" class="form-select form-select-sm" onchange="updateTargetTime()">
                                <option value="UTC">UTC (GMT)</option>
                                <!-- Dynamically populated -->
                            </select>
                        </div>
                        <div class="p-3 bg-light rounded-3">
                            <label class="form-label small text-muted">Time in Selected Zone:</label>
                            <div id="target-time" class="fw-bold fs-5"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }
    .glass-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.2) !important;
        background: rgba(255, 255, 255, 0.8);
    }
    .icon-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    body {
        min-height: 100vh;
    }
    #timezone-select {
        max-height: 200px;
    }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

@section Scripts {
    <script>
        // --- Weather Logic ---
        async function fetchWeather(location = '') {
            const content = document.getElementById('weather-content');
            content.innerHTML = `
                <div class="d-flex justify-content-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

            try {
                // Using wttr.in for weather data
                // default to capital for country if only country is provided
                const response = await fetch(`https://wttr.in/${location || ''}?format=j1`);
                if (!response.ok) throw new Error('Location not found');
                const data = await response.json();
                
                const current = data.current_condition[0];
                const weatherToday = data.weather[0];
                const area = data.nearest_area[0];
                
                // Prioritize searched name for display if available
                let displayName = location ? location.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') : area.areaName[0].value;
                const countryName = area.country ? area.country[0].value : '';
                const fullLocation = countryName ? `${displayName}, ${countryName}` : displayName;

                // Map weather codes to icons or use descriptions
                const weatherDesc = current.weatherDesc[0].value;
                
                content.innerHTML = `
                    <div class="weather-main mb-4">
                        <div class="display-4 fw-bold text-primary mb-0">${current.temp_C}째C</div>
                        <div class="fs-5 fw-semibold text-dark text-capitalize">${weatherDesc}</div>
                        <div class="small text-muted">RealFeel: ${current.FeelsLikeC}째C</div>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="stats-box p-3 rounded-4 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center">
                                <i class="bi bi-thermometer-low text-primary fs-4 mb-1 d-block"></i>
                                <span class="d-block small text-muted">Today's Min</span>
                                <span class="fw-bold fs-5 text-primary">${weatherToday.mintempC}째C</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-3 rounded-4 bg-danger bg-opacity-10 border border-danger border-opacity-10 text-center">
                                <i class="bi bi-thermometer-high text-danger fs-4 mb-1 d-block"></i>
                                <span class="d-block small text-muted">Today's Max</span>
                                <span class="fw-bold fs-5 text-danger">${weatherToday.maxtempC}째C</span>
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/${encodeURIComponent(fullLocation)}" 
                       target="_blank" 
                       class="location-info p-2 rounded-pill bg-light mb-3 mx-auto d-inline-block px-4 text-decoration-none text-dark hover-link"
                       title="View on Google Maps">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                        <span class="fw-medium">${fullLocation}</span>
                    </a>
                    
                    <div class="d-flex justify-content-between px-3 py-2 border-top mt-2">
                        <div class="text-center">
                            <i class="bi bi-droplets-fill text-info d-block fs-5"></i>
                            <span class="small fw-bold">${current.humidity}%</span>
                            <div class="text-muted smaller">Humidity</div>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-wind text-secondary d-block fs-5"></i>
                            <span class="small fw-bold">${current.windspeedKmph} km/h</span>
                            <div class="text-muted smaller">Wind</div>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-eye-fill text-warning d-block fs-5"></i>
                            <span class="small fw-bold">${current.visibility} km</span>
                            <div class="text-muted smaller">Visibility</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger py-2 px-3 small rounded-3 mx-2">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Could not find weather for "${location}".
                    </div>
                `;
                console.error('Weather error:', error);
            }
        }

        function updateWeather() {
            const location = document.getElementById('location-input').value.trim();
            fetchWeather(location);
        }

        // --- Currency Logic ---
        async function initCurrencies() {
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                
                if (data.result === "success") {
                    const currencies = Object.keys(data.rates).sort();
                    const fromSelect = document.getElementById('from-currency');
                    const toSelect = document.getElementById('to-currency');
                    
                    const fromVal = fromSelect.value;
                    const toVal = toSelect.value;
                    
                    fromSelect.innerHTML = '';
                    toSelect.innerHTML = '';
                    
                    currencies.forEach(curr => {
                        const opt1 = document.createElement('option');
                        opt1.value = curr;
                        opt1.text = curr;
                        fromSelect.appendChild(opt1);
                        
                        const opt2 = document.createElement('option');
                        opt2.value = curr;
                        opt2.text = curr;
                        toSelect.appendChild(opt2);
                    });
                    
                    fromSelect.value = fromVal || 'USD';
                    toSelect.value = toVal || 'INR';
                }
            } catch (error) {
                console.error('Failed to load currencies:', error);
            }
        }

        async function convertCurrency() {
            const amount = document.getElementById('amount').value;
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            const resDiv = document.getElementById('currency-result');

            resDiv.innerHTML = '<span class="small text-muted">Converting...</span>';

            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                const data = await response.json();
                
                if (data.result === "success") {
                    const rate = data.rates[to];
                    const converted = (amount * rate).toFixed(2);
                    resDiv.innerHTML = `${amount} ${from} = ${converted} ${to}`;
                } else {
                    resDiv.innerHTML = 'Error fetching rates';
                }
            } catch (error) {
                resDiv.innerHTML = 'Error converting';
                console.error('Currency error:', error);
            }
        }

        // --- Time Logic ---
        function initTimezones() {
            const select = document.getElementById('timezone-select');
            // Get all IANA timezones supported by the browser
            const zones = Intl.supportedValuesOf('timeZone');
            zones.sort();

            select.innerHTML = '';
            zones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.text = tz.replace(/_/g, ' '); 
                select.appendChild(option);
            });
            
            // Try to set local timezone as default
            const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (zones.includes(localTz)) {
                select.value = localTz;
            }
        }

        function updateTimes() {
            const now = new Date();
            document.getElementById('local-time').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            updateTargetTime();
        }

        function updateTargetTime() {
            const select = document.getElementById('timezone-select');
            const timezone = select.value;
            if (!timezone) {
                document.getElementById('target-time').innerText = "-- : -- : --";
                return;
            }
            const now = new Date();
            try {
                const targetTimeStr = now.toLocaleTimeString('en-US', { 
                    timeZone: timezone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('target-time').innerText = targetTimeStr;
            } catch (e) {
                document.getElementById('target-time').innerText = "Error";
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchWeather(); // Default location
            initCurrencies();
            initTimezones();
            window.timeUpdateInterval = setInterval(updateTimes, 1000);
            updateTimes();
            // Initial conversion delayed slightly to allow currencies to load
            setTimeout(convertCurrency, 1000);
        });
    </script>
}
