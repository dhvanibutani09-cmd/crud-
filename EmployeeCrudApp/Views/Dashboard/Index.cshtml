@model DashboardViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Dashboard"];
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 text-dark">
        <h1 class="mb-0">@Localizer["Welcome"], @(User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? User.Identity?.Name)!</h1>
        <a asp-controller="User" asp-action="Index" class="btn btn-outline-dark rounded-pill px-4">
            <i class="bi bi-people-fill me-2"></i> @Localizer["Manage Users"]
        </a>
    </div>
    
    <div class="row g-4">
        <!-- Weather Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-cloud-sun-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Weather Details"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Real-time climate"]</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-grow-1">
                        <div id="weather-content" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">@Localizer["Loading..."]</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="location-input" class="form-control border-0 px-3" placeholder="@Localizer["Search city..."]" onkeydown="if(event.key==='Enter'){event.preventDefault(); updateWeather();}">
                            <button type="button" onclick="updateWeather()" class="btn btn-primary border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currency Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-currency-exchange"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Currency Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Global exchange rates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="input-group input-group-sm mb-3 shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text border-0 bg-light px-3 small">@Localizer["Amount"]</span>
                            <input type="number" id="amount" class="form-control border-0 text-center fw-bold" value="1">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <select id="from-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="USD" selected>USD</option>
                                </select>
                            </div>
                            <div class="col">
                                <select id="to-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="INR" selected>INR</option>
                                </select>
                            </div>
                        </div>
                        <div id="currency-result" class="text-center py-3 bg-success bg-opacity-10 rounded-4 border border-success border-opacity-10 mb-3" style="min-height: 80px;"></div>
                    </div>

                    <button onclick="convertCurrency()" class="btn btn-success w-100 rounded-pill shadow-sm fw-bold py-2 mt-auto">
                        <i class="bi bi-arrow-repeat me-2"></i>@Localizer["Convert"]
                    </button>
                </div>
            </div>
        </div>

        <!-- Time Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card overflow-visible">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-info text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-clock-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Time Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["World clock"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="text-center mb-4 p-3 bg-light rounded-4 border">
                            <label class="form-label smaller text-muted text-uppercase fw-bold mb-2 ls-1">@Localizer["Current Local Time"]</label>
                            <div id="local-time" class="fw-bold fs-2 text-info"></div>
                        </div>

                        <div class="position-relative mb-4">
                            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border">
                                <span class="input-group-text border-0 bg-white ps-3"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="timezone-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country, city..."]" oninput="handleGlobalSearch()">
                            </div>
                            <div id="search-results" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none" style="position: absolute; width:100%; z-index: 1000; max-height: 200px; overflow-y: auto; background: white; margin-top: 5px; border: 1px solid #eee;">
                            </div>
                        </div>

                        <div id="target-time-card" class="p-3 bg-info bg-opacity-10 border border-info border-opacity-10 rounded-4 text-center">
                            <div id="target-location-display" class="smaller fw-bold text-dark text-uppercase mb-1 ls-1">UTC (GMT)</div>
                            <div id="target-time" class="fw-bold fs-3 text-info">-- : -- : --</div>
                            <div id="target-date" class="smaller fw-medium mt-1"></div>
                            <div id="relative-day" class="badge rounded-pill mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- News Card -->
        <div class="col-md-6">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-newspaper"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Headlines"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Latest world updates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="news-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search news..."]" style="font-size: 0.8rem;" onkeydown="if(event.key==='Enter'){event.preventDefault(); searchNews();}">
                            <button type="button" onclick="searchNews()" class="btn btn-danger border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="news-container" class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <div class="text-center py-4">
                            <div class="spinner-border text-danger spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">@Localizer["Fetching news..."]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Card (New Widget) -->
        <div class="col-md-6">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-warning text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-sticky-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Personal Notes"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Capture your thoughts"]</p>
                            </div>
                        </div>
                        <button class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold text-white" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="bi bi-plus-lg me-2"></i> @Localizer["Add Note"]
                        </button>
                    </div>

                    <div id="notes-container" class="row g-3">
                        @if (Model.Notes.Any())
                        {
                            @foreach (var note in Model.Notes)
                            {
                                <div class="col-sm-6">
                                    <div class="note-item h-100 p-3 rounded-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 shadow-sm d-flex flex-column">
                                        <div class="p-2 flex-grow-1 text-dark small" style="white-space: pre-wrap; font-family: 'Inter', sans-serif;">@note.Text</div>
                                        <div class="mt-3 pt-3 border-top border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                            <span class="smaller text-muted">
                                                <i class="bi bi-clock me-1"></i> @note.CreatedAt.ToString("MMM dd, HH:mm")
                                            </span>
                                            <div class="btn-group">
                                                <button class="btn btn-link btn-sm text-dark p-0 me-2" onclick="openEditModal(@note.Id, `@note.Text.Replace("`", "\\`")`)"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteNote(@note.Id)"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12 text-center py-5">
                                <div class="text-muted mb-2 opacity-25"><i class="bi bi-journal-text" style="font-size: 3rem;"></i></div>
                                <p class="text-muted">@Localizer["No notes yet. Click 'Add Note' to start writing."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="addNoteModalLabel">@Localizer["Add New Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="new-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="saveNewNote()">@Localizer["Save Note"]</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="editNoteModalLabel">@Localizer["Edit Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id" />
                <textarea id="edit-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="updateNote()">@Localizer["Save Changes"]</button>
            </div>
        </div>
    </div>
</div>
    


<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }
    .glass-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.2) !important;
        background: rgba(255, 255, 255, 0.8);
    }
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    body {
        min-height: 100vh;
    }
    #timezone-select {
        max-height: 200px;
    }

    /* Currency Enhancements */
    .currency-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .flag-icon {
        width: 20px;
        height: 15px;
        object-fit: cover;
        border-radius: 2px;
    }
    #currency-result {
        background: rgba(25, 135, 84, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }

    /* Time Enhancements */
    #target-time-card {
        transition: all 0.3s ease;
    }
    .badge-today { background-color: #0dcaf0; color: white; }
    .badge-yesterday { background-color: #6c757d; color: white; }
    .badge-tomorrow { background-color: #198754; color: white; }

    /* News Enhancements */
    .object-fit-cover { object-fit: cover; }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .hover-shadow { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .carousel-item { transition: transform 0.6s ease-in-out; }
    .carousel-indicators [data-bs-target] { background-color: #dc3545; }
    .carousel-control-prev-icon, .carousel-control-next-icon { filter: invert(1) grayscale(100); }

    /* Note Enhancements */
    .note-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: default;
    }
    .note-item:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .smaller { font-size: 0.75rem; }
    .ls-1 { letter-spacing: 1px; }

</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

@section Scripts {
    <script>
        // --- Weather Logic ---
        async function detectLocationAndFetchWeather() {
            const content = document.getElementById('weather-content');
            
            // Show detecting spinner
            content.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">@Localizer["Loading..."]</span>
                    </div>
                    <p class="text-secondary fw-medium mb-0">@Localizer["Detecting location..."]</p>
                    <p class="small text-muted">@Localizer["Please allow GPS access if prompted."]</p>
                </div>
            `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeather(`${latitude},${longitude}`);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                        content.innerHTML = `
                            <div class="text-center p-4">
                                <i class="bi bi-geo-alt-fill text-muted fs-1 d-block mb-3"></i>
                                <p class="text-secondary fw-medium mb-0">@Localizer["Location access denied."]</p>
                                <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                            </div>
                        `;
                    },
                    { 
                        timeout: 5000,
                        enableHighAccuracy: true 
                    }
                );
            } else {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-exclamation-circle text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Geolocation not supported."]</p>
                        <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                    </div>
                `;
            }
        }

        async function fetchWeather(location = '') {
            const content = document.getElementById('weather-content');
            
            if (!location) {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-search text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Ready to search."]</p>
                        <p class="small text-muted">@Localizer["Enter a city to see the weather."]</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center p-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="small text-muted">@Localizer["Fetching weather data..."]</span>
                </div>
            `;

            try {
                // Using wttr.in for weather data
                // Forced metric (m) to ensure Celsius and km/h
                const response = await fetch(`https://wttr.in/${location || ''}?m&format=j1`);
                if (!response.ok) throw new Error('Location not found');
                const data = await response.json();
                
                const current = data?.current_condition?.[0] || {};
                const weatherToday = data?.weather?.[0] || {};
                const astronomy = weatherToday?.astronomy?.[0] || { sunrise: '--', sunset: '--' };
                const area = data?.nearest_area?.[0] || { areaName: [{ value: 'Unknown' }] };
                
                // Safe extraction of precipitation chance
                const chanceOfRain = (weatherToday?.hourly?.[0]?.chanceofrain || '0') + '%';
                
                // Display logic
                let displayName = '';
                if (location && !location.includes(',')) {
                    // Manual city search
                    displayName = location.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                } else {
                    // Coordinates or IP-based detection
                    displayName = area.areaName?.[0]?.value || '@Localizer["Current Location"]';
                }

                const countryName = area.country?.[0]?.value || '';
                const fullLocation = countryName ? `${displayName}, ${countryName}` : displayName;

                const weatherDesc = current?.weatherDesc?.[0]?.value || '@Localizer["Unknown"]';
                const now = new Date();
                const lastUpdated = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                content.innerHTML = `
                    <div class="weather-main mb-4">
                        <div class="display-4 fw-bold text-primary mb-0">${current?.temp_C || '--'}째C</div>
                        <div class="small fw-semibold text-muted mb-2"><i class="bi bi-thermometer-half"></i> @Localizer["Accurate Celsius"]</div>
                        <div class="fs-5 fw-semibold text-dark text-capitalize lh-sm mb-1">${weatherDesc}</div>
                        <div class="small text-muted mb-2">@Localizer["RealFeel"]: ${current?.FeelsLikeC || '--'}째C</div>
                        ${location && location.includes(',') ? '<div class="badge bg-info bg-opacity-10 text-info mt-1"><i class="bi bi-crosshair me-1"></i> @Localizer["Current Location"]</div>' : ''}
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunrise"]</span>
                                <span class="fw-bold small text-warning"><i class="bi bi-sunrise me-1"></i>${astronomy.sunrise}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunset"]</span>
                                <span class="fw-bold small text-danger"><i class="bi bi-sunset me-1"></i>${astronomy.sunset}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["UV Index"]</span>
                                <span class="fw-bold small text-primary">${current?.uvIndex || '0'}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-info bg-opacity-10 border border-info border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Pressure"]</span>
                                <span class="fw-bold small text-info">${current?.pressure || '--'} hPa</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Humidity"]</span>
                                <span class="fw-bold small text-success">${current?.humidity || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Rain Chance"]</span>
                                <span class="fw-bold small text-warning-emphasis"><i class="bi bi-cloud-rain me-1"></i>${chanceOfRain}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Cloud Cover"]</span>
                                <span class="fw-bold small text-secondary-emphasis"><i class="bi bi-clouds me-1"></i>${current?.cloudcover || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/${encodeURIComponent(fullLocation)}" 
                       target="_blank" 
                       class="location-info p-2 rounded-pill bg-light mb-3 mx-auto d-inline-block px-4 text-decoration-none text-dark hover-link border"
                       title="@Localizer["View on Google Maps"]">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                        <span class="fw-medium">${fullLocation}</span>
                    </a>
                    
                    <div class="d-flex justify-content-between px-3 py-2 border-top mt-2">
                        <div class="text-center">
                            <i class="bi bi-thermometer-low text-primary d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.mintempC || '--'}째C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-thermometer-high text-danger d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.maxtempC || '--'}째C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-wind text-secondary d-block"></i>
                            <span class="smaller fw-bold">${current?.windspeedKmph || '0'} @Localizer["km/h"]</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-eye-fill text-warning d-block"></i>
                            <span class="smaller fw-bold">${current?.visibility || '0'} @Localizer["km"]</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="smaller text-muted" style="font-size: 0.7rem;">
                            <i class="bi bi-arrow-repeat me-1"></i>@Localizer["Last updated:"] ${lastUpdated}
                        </span>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger py-3 px-3 small rounded-4 mx-2 text-center shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                        <p class="mb-2">@Localizer["Could not load weather for"] "${location}".</p>
                        <button onclick="fetchWeather('${location}')" class="btn btn-danger btn-sm rounded-pill px-4">
                            <i class="bi bi-arrow-clockwise me-1"></i> @Localizer["Retry"]
                        </button>
                    </div>
                `;
                console.error('Weather error:', error);
            }
        }

        function updateWeather() {
            const location = document.getElementById('location-input').value.trim();
            fetchWeather(location);
        }

        // --- Currency Logic ---
        let currencyInfoMap = {};

        async function initCurrencies() {
            try {
                // Fetch exchange rates and country info in parallel
                const [rateRes, countryRes] = await Promise.all([
                    fetch('https://open.er-api.com/v6/latest/USD'),
                    fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2')
                ]);

                const rateData = await rateRes.json();
                const countryData = await countryRes.json();
                
                if (rateData.result === "success") {
                    let currencyOptions = [];

                    // Process country data
                    countryData.forEach(country => {
                        if (country.currencies) {
                            Object.entries(country.currencies).forEach(([code, details]) => {
                                // Include all countries, even if rate is missing
                                currencyOptions.push({
                                    countryName: country.name.common,
                                    countryCode: country.cca2,
                                    currencyCode: code,
                                    currencyName: details.name,
                                    flag: country.flags.svg,
                                    // Unique value for select option to prevent jumping
                                    value: `${code}|${country.cca2}`
                                });

                                // Store info for display
                                currencyInfoMap[`${code}|${country.cca2}`] = {
                                    name: details.name,
                                    symbol: details.symbol,
                                    flag: country.flags.svg,
                                    country: country.name.common
                                };
                            });
                        }
                    });

                    // Sort by country name
                    currencyOptions.sort((a, b) => a.countryName.localeCompare(b.countryName));

                    const fromSelect = document.getElementById('from-currency');
                    const toSelect = document.getElementById('to-currency');
                    
                    const populateSelect = (select, defaultCountryCode, defaultCurrencyCode) => {
                        select.innerHTML = '';
                        let defaultFound = false;
                        
                        currencyOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = `${opt.countryName} - ${opt.currencyName} (${opt.currencyCode})`;
                            select.appendChild(option);

                            // auto-select defaults (US for USD, IN for INR)
                            if (!defaultFound && opt.countryCode === defaultCountryCode && opt.currencyCode === defaultCurrencyCode) {
                                select.value = opt.value;
                                defaultFound = true;
                            }
                        });
                    };

                    populateSelect(fromSelect, 'US', 'USD');
                    populateSelect(toSelect, 'IN', 'INR');
                }
            } catch (error) {
                console.error('Failed to load currencies:', error);
            }
        }

        async function convertCurrency() {
            const amountInput = document.getElementById('amount');
            const amount = amountInput.value || 1;
            // Value format is "CODE|COUNTRY_CODE"
            const fromValue = document.getElementById('from-currency').value;
            const toValue = document.getElementById('to-currency').value;
            
            if (!fromValue || !toValue) return;

            const fromCode = fromValue.split('|')[0];
            const toCode = toValue.split('|')[0];
            
            const resDiv = document.getElementById('currency-result');

            resDiv.innerHTML = `
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="small text-muted">@Localizer["Calculating..."]</span>
                </div>
            `;

            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${fromCode}`);
                const data = await response.json();
                
                if (data.result === "success") {
                    const rate = data.rates[toCode];
                    
                    if (rate !== undefined) {
                        const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        
                        const fromInfo = currencyInfoMap[fromValue];
                        const toInfo = currencyInfoMap[toValue];

                        resDiv.innerHTML = `
                            <div class="text-start">
                                <div class="small text-muted mb-1">
                                    <img src="${fromInfo.flag}" class="flag-icon me-1" style="width: 20px; height: 15px; vertical-align: middle;">
                                    ${amount} ${fromInfo.country} (${fromCode}) @Localizer["equals"]
                                </div>
                                <div class="h3 fw-bold mb-0">
                                    <img src="${toInfo.flag}" class="flag-icon me-1" style="width: 30px; height: 22px; vertical-align: baseline;">
                                    ${converted} ${toInfo.currencyName}
                                </div>
                                 <div class="small text-muted mt-1">@Localizer["in"] ${toInfo.country}</div>
                            </div>
                        `;
                    } else {
                        resDiv.innerHTML = '<div class="text-warning small text-center"><i class="bi bi-exclamation-circle me-1"></i> @Localizer["Exchange rate unavailable"]</div>';
                        console.warn(`Rate not found for ${toCode}`);
                    }
                } else {
                    resDiv.innerHTML = ''; // Silently fail
                    console.warn('Error fetching rates');
                }
            } catch (error) {
                resDiv.innerHTML = ''; // Silently fail
                console.error('Currency error:', error);
            }
        }

        // --- Time Logic ---
        let currentTargetTimezone = 'UTC';
        let currentTargetLocationName = 'UTC (GMT)';
        const searchCache = new Map(); // Cache for search results

        let searchTimeout;
        async function handleGlobalSearch() {
            const query = document.getElementById('timezone-search').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 3) {
                resultsDiv.classList.add('d-none');
                return;
            }

            // Check Cache
            if (searchCache.has(query.toLowerCase())) {
                renderSearchResults(searchCache.get(query.toLowerCase()));
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    // Single API call for Location + Timezone
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item small text-muted text-center py-3">@Localizer["No location found"]</div>';
                        resultsDiv.classList.remove('d-none');
                        return;
                    }

                    // Cache results
                    searchCache.set(query.toLowerCase(), data.results);
                    renderSearchResults(data.results);

                } catch (error) {
                    console.error('Geo search error:', error);
                }
            }, 300); 
        }

        function renderSearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            const input = document.getElementById('timezone-search');
            
            // --- Auto-select first result (Optimistic) ---
            const first = results[0];
            updateTimezoneFromData(first, false); // Don't update input text yet

            // --- Populate dropdown ---
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('d-none');
            
            results.forEach(item => {
                const name = item.name;
                const country = item.country || '';
                const admin1 = item.admin1 || '';
                const details = [admin1, country].filter(x => x && x !== name).join(', ');
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action small py-2 px-3 border-0';
                btn.innerHTML = `
                    <div class="fw-bold text-start">${name}</div>
                    <div class="smaller text-muted text-start">${details}</div>
                `;
                
                btn.onclick = () => {
                    resultsDiv.classList.add('d-none');
                    input.value = `${name}, ${country}`;
                    updateTimezoneFromData(item, true);
                };
                resultsDiv.appendChild(btn);
            });
        }

        function updateTimezoneFromData(item, updateLabel) {
            if (item.timezone) {
                currentTargetTimezone = item.timezone;
                currentTargetLocationName = `${item.name}, ${item.country || ''}`;
                updateTargetTime();
            }
        }



        function updateTimes() {
            const now = new Date();
            const culture = window.APP_CULTURE || 'en-US';
            document.getElementById('local-time').innerText = now.toLocaleTimeString(culture, { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            updateTargetTime();
        }

        function updateTargetTime() {
            const timezone = currentTargetTimezone;
            const targetTimeDiv = document.getElementById('target-time');
            const targetDateDiv = document.getElementById('target-date');
            const relativeDayDiv = document.getElementById('relative-day');
            const locationDisplay = document.getElementById('target-location-display');

            if (locationDisplay) locationDisplay.innerText = currentTargetLocationName;

            if (!timezone) {
                // ... (fallback)
                return;
            }

            const now = new Date();
            const culture = window.APP_CULTURE || 'en-US';
            try {
                // Time
                const targetTimeStr = now.toLocaleTimeString(culture, { 
                    timeZone: timezone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true
                });
                targetTimeDiv.innerText = targetTimeStr;

                // Date
                const options = { timeZone: timezone, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const targetDateStr = now.toLocaleDateString(culture, options);
                targetDateDiv.innerText = targetDateStr;

                // Relative Day logic
                const localDateStr = now.toLocaleDateString(culture);
                const targetDateSimpleStr = now.toLocaleDateString(culture, { timeZone: timezone });
                
                const localDate = new Date(localDateStr);
                const targetDate = new Date(targetDateSimpleStr);
                
                const diffTime = targetDate - localDate;
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                relativeDayDiv.className = 'badge rounded-pill mt-2';
                if (diffDays === 0) {
                    relativeDayDiv.innerText = "";
                } else if (diffDays > 0) {
                    relativeDayDiv.innerText = "@Localizer["Tomorrow"]";
                    relativeDayDiv.classList.add('badge-tomorrow');
                } else { // diffDays < 0
                    relativeDayDiv.innerText = "@Localizer["Yesterday"]";
                    relativeDayDiv.classList.add('badge-yesterday');
                }

            } catch (e) {
                targetTimeDiv.innerText = "@Localizer["Error"]";
                targetDateDiv.innerText = "";
                relativeDayDiv.innerText = "";
            }
        }




        // --- News Logic ---
        async function fetchNews(query = '') {
            const container = document.getElementById('news-container');
            
            // Show loading state
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">@Localizer["Fetching"] ${query ? '@Localizer["search results"]' : '@Localizer["latest updates"]'}...</p>
                </div>
            `;
            
            try {
                // Build URL - Default to Global (no country param), English language handled by backend
                let url = '/News/GetNews';
                const params = [];
                
                if (query) {
                    params.push(`query=${encodeURIComponent(query)}`);
                }
                
                if (params.length > 0) {
                    url += '?' + params.join('&');
                }

                const response = await fetch(url); 
                const data = await response.json();
                
                if (data.status === 'ok' && data.articles) {
                    container.innerHTML = ''; // Clear loading
                    
                    // Limit to 5 items for carousel
                    const articles = data.articles.filter(a => a.title && a.urlToImage).slice(0, 5); // Filter out items without images/titles
                    
                    if (articles.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-4 w-100">
                                <div class="text-muted mb-2"><i class="bi bi-search fs-3 opacity-25"></i></div>
                                <p class="small text-muted mb-2">@Localizer["No results."]</p>
                                <button onclick="document.getElementById('news-search-input').value = ''; fetchNews();" class="btn btn-xs btn-outline-secondary rounded-pill" style="font-size: 0.75rem;">@Localizer["Clear"]</button>
                            </div>
                        `;
                        return;
                    }

                    // Build Carousel HTML
                    let carouselHtml = `
                        <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel" style="width: 100%;">
                            <div class="carousel-indicators" style="margin-bottom: -1rem;">
                                ${articles.map((_, index) => `
                                    <button type="button" data-bs-target="#newsCarousel" data-bs-slide-to="${index}" class="${index === 0 ? 'active' : ''}" aria-current="${index === 0}" aria-label="Slide ${index + 1}" style="width: 6px; height: 6px; border-radius: 50%;"></button>
                                `).join('')}
                            </div>
                            <div class="carousel-inner rounded-3 overflow-hidden">
                    `;

                    articles.forEach((article, index) => {
                         // Fallback image
                        const imgUrl = article.urlToImage || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop';
                        const date = new Date(article.publishedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        
                        carouselHtml += `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <div class="position-relative">
                                    <img src="${imgUrl}" class="d-block w-100 object-fit-cover" alt="News" style="height: 180px;" onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop'">
                                    <div class="position-absolute bottom-0 start-0 w-100 p-2 text-white" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                        <span class="badge bg-danger shadow-sm" style="font-size: 0.65rem;">${article.source.name}</span>
                                    </div>
                                </div>
                                <div class="mt-2 text-start">
                                    <h6 class="fw-bold mb-1 line-clamp-2" style="font-size: 0.9rem;">
                                        <a href="${article.url}" target="_blank" class="text-dark text-decoration-none stretched-link">
                                            ${article.title}
                                        </a>
                                    </h6>
                                    <p class="small text-muted mb-0" style="font-size: 0.75rem;">${date}</p>
                                </div>
                            </div>
                        `;
                    });

                    carouselHtml += `
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#newsCarousel" data-bs-slide="prev" style="width: 10%;">
                                <span class="carousel-control-prev-icon" aria-hidden="true" style="width: 1rem; height: 1rem;"></span>
                                <span class="visually-hidden">@Localizer["Previous"]</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#newsCarousel" data-bs-slide="next" style="width: 10%;">
                                <span class="carousel-control-next-icon" aria-hidden="true" style="width: 1rem; height: 1rem;"></span>
                                <span class="visually-hidden">@Localizer["Next"]</span>
                            </button>
                        </div>
                    `;

                    container.innerHTML = carouselHtml;
                    
                    // Initialize carousel manually to ensure specific behavior if needed
                    // const myCarousel = document.querySelector('#newsCarousel');
                    // const carousel = new bootstrap.Carousel(myCarousel, { interval: 5000 });

                } else {
                    throw new Error(data.message || 'Failed to load news');
                }
            } catch (error) {
                console.error('News error:', error);
                container.innerHTML = `
                    <div class="text-center text-muted py-4 w-100">
                        <i class="bi bi-exclamation-circle mb-2 fs-5 text-warning"></i>
                        <p class="small mb-1">@Localizer["Unable to load news."]</p>
                        <button onclick="fetchNews('${query}')" class="btn btn-xs btn-link p-0 text-muted">@Localizer["Retry"]</button>
                    </div>
                `;
            }
        }

        async function saveNewNote() {
            const text = document.getElementById('new-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/AddNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Add note error:', error);
            }
        }

        function openEditModal(id, text) {
            document.getElementById('edit-note-id').value = id;
            document.getElementById('edit-note-text').value = text;
            const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            modal.show();
        }

        async function updateNote() {
            const id = document.getElementById('edit-note-id').value;
            const text = document.getElementById('edit-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/EditNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}&text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Update note error:', error);
            }
        }

        async function deleteNote(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this note?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete note error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            detectLocationAndFetchWeather(); // Detect and fetch
            initCurrencies();
            // initTimezones(); REMOVED
            window.timeUpdateInterval = setInterval(updateTimes, 1000);
            
            // Auto-refresh weather every 10 minutes ONLY if we have a location
            if (window.weatherRefreshInterval) clearInterval(window.weatherRefreshInterval);
            window.weatherRefreshInterval = setInterval(() => {
                const currentLoc = document.querySelector('.location-info .fw-medium')?.innerText;
                if (currentLoc) {
                    // Refresh current displayed location
                    fetchWeather(currentLoc);
                } else {
                    // Try to re-detect if nothing is shown
                    detectLocationAndFetchWeather();
                }
            }, 10 * 60 * 1000);
            
            updateTimes();
            // Initial conversion delayed slightly to allow currencies to load
            setTimeout(convertCurrency, 1000);
            
            fetchNews();

        });
    </script>
}
