@model DashboardViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Dashboard"];
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 text-dark">
        <h1 class="mb-0">@Localizer["Welcome"], @(User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? User.Identity?.Name)!</h1>
        <a asp-controller="User" asp-action="Index" class="btn btn-outline-dark rounded-pill px-4">
            <i class="bi bi-people-fill me-2"></i> @Localizer["Manage Users"]
        </a>
    </div>
    
    <div class="row g-4">
        <!-- Weather Card -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-cloud-sun-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Weather Details"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Real-time climate"]</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-grow-1">
                        <div id="weather-content" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">@Localizer["Loading..."]</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="location-input" class="form-control border-0 px-3" placeholder="@Localizer["Search city..."]" onkeydown="if(event.key==='Enter'){event.preventDefault(); updateWeather();}">
                            <button type="button" onclick="updateWeather()" class="btn btn-primary border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currency Conversion Card -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-currency-exchange"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Currency Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Global exchange rates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="input-group input-group-sm mb-3 shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text border-0 bg-light px-3 small">@Localizer["Amount"]</span>
                            <input type="number" id="amount" class="form-control border-0 text-center fw-bold" value="1">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <select id="from-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="USD" selected>USD</option>
                                </select>
                            </div>
                            <div class="col">
                                <select id="to-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="INR" selected>INR</option>
                                </select>
                            </div>
                        </div>
                        <div id="currency-result" class="text-center py-3 bg-success bg-opacity-10 rounded-4 border border-success border-opacity-10 mb-3" style="min-height: 80px;"></div>
                    </div>

                    <button onclick="convertCurrency()" class="btn btn-success w-100 rounded-pill shadow-sm fw-bold py-2 mt-auto">
                        <i class="bi bi-arrow-repeat me-2"></i>@Localizer["Convert"]
                    </button>
                </div>
            </div>
        </div>

        <!-- Time Conversion Card -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card overflow-visible">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-info text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-clock-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Time Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["World clock"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="text-center mb-4 p-3 bg-light rounded-4 border">
                            <label class="form-label smaller text-muted text-uppercase fw-bold mb-2 ls-1">@Localizer["Current Local Time"]</label>
                            <div id="local-time" class="fw-bold fs-2 text-info"></div>
                        </div>

                        <div class="position-relative mb-4">
                            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border">
                                <span class="input-group-text border-0 bg-white ps-3"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="timezone-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country, city..."]" oninput="handleGlobalSearch()">
                            </div>
                            <div id="search-results" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none" style="position: absolute; width:100%; z-index: 1000; max-height: 200px; overflow-y: auto; background: white; margin-top: 5px; border: 1px solid #eee;">
                            </div>
                        </div>

                        <div id="target-time-card" class="p-3 bg-info bg-opacity-10 border border-info border-opacity-10 rounded-4 text-center">
                            <div id="target-location-display" class="smaller fw-bold text-dark text-uppercase mb-1 ls-1">UTC (GMT)</div>
                            <div id="target-time" class="fw-bold fs-3 text-info">-- : -- : --</div>
                            <div id="target-date" class="smaller fw-medium mt-1"></div>
                            <div id="relative-day" class="badge rounded-pill mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- News Card -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-newspaper"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Headlines"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Latest world updates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex gap-2">
                            <select id="news-country-select" class="form-select form-select-sm rounded-pill border-0 shadow-sm bg-light px-3" style="font-size: 0.8rem; width: auto;" onchange="fetchNews(document.getElementById('news-search-input').value, this.value)">
                                <option value="us">@Localizer["USA"]</option>
                                <option value="in" selected>@Localizer["India"]</option>
                                <option value="gb">@Localizer["UK"]</option>
                                <option value="ca">@Localizer["Canada"]</option>
                                <option value="au">@Localizer["Australia"]</option>
                                <option value="ae">@Localizer["UAE"]</option>
                            </select>
                            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden flex-grow-1">
                                <input type="text" id="news-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search news..."]" style="font-size: 0.8rem;" onkeydown="if(event.key==='Enter'){event.preventDefault(); searchNews();}">
                                <button type="button" onclick="searchNews()" class="btn btn-danger border-0 px-3">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="news-container" class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <div class="text-center py-4">
                            <div class="spinner-border text-danger spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">@Localizer["Fetching news..."]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Country Search Card -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background-color: #6610f2 !important;">
                                <i class="bi bi-globe"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["World Countries"]</h6>
                                <p class="text-muted small mb-0">@Localizer["All Country Details"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="country-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search country..."]" oninput="filterCountries(this.value)">
                            <button type="button" onclick="showCountryList()" class="btn btn-primary border-0 px-3" style="background-color: #6610f2 !important;">
                                <i class="bi bi-x-lg" id="country-search-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="country-container" class="flex-grow-1 overflow-auto" style="max-height: 350px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Card (New Widget) -->
        <div class="col-md-4">


            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-warning text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-sticky-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Personal Notes"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Capture your thoughts"]</p>
                            </div>
                        </div>
                        <button class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold text-white" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="bi bi-plus-lg me-2"></i> @Localizer["Add Note"]
                        </button>
                    </div>

                    <div id="notes-container" class="row g-3">
                        @if (Model.Notes.Any())
                        {
                            @foreach (var note in Model.Notes)
                            {
                                <div class="col-12">
                                    <div class="note-item h-100 p-3 rounded-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 shadow-sm d-flex flex-column">
                                        <div class="p-2 flex-grow-1 text-dark small" style="white-space: pre-wrap; font-family: 'Inter', sans-serif;">@note.Text</div>
                                        <div class="mt-3 pt-3 border-top border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                            <span class="smaller text-muted">
                                                <i class="bi bi-clock me-1"></i> @note.CreatedAt.ToString("MMM dd, HH:mm")
                                            </span>
                                            <div class="btn-group">
                                                <button class="btn btn-link btn-sm text-dark p-0 me-2" onclick="openEditModal(@note.Id, `@note.Text.Replace("`", "\\`")`)"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteNote(@note.Id)"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12 text-center py-5">
                                <div class="text-muted mb-2 opacity-25"><i class="bi bi-journal-text" style="font-size: 3rem;"></i></div>
                                <p class="text-muted">@Localizer["No notes yet. Click 'Add Note' to start writing."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <!-- Habit Tracker Card -->
        <div class="col-md-4">



            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Habit Tracker"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Build better habits"]</p>
                            </div>
                        </div>
                        <button class="btn btn-success rounded-pill px-4 shadow-sm fw-bold text-white small" data-bs-toggle="modal" data-bs-target="#addHabitModal">
                            <i class="bi bi-plus-lg me-1"></i> @Localizer["Add"]
                        </button>
                    </div>

                    <div class="flex-grow-1">
                        <!-- Daily Progress Bar -->
                        @{
                            var totalHabits = Model.Habits.Count;
                            var completedToday = Model.Habits.Count(h => h.IsCompletedToday);
                            var progress = totalHabits > 0 ? (int)((double)completedToday / totalHabits * 100) : 0;
                        }
                        <div class="mb-4">
                            <div class="d-flex justify-content-between small mb-1">
                                <span class="fw-bold text-muted">@Localizer["All Progress"]</span>
                                <span class="fw-bold text-success">@progress%</span>
                            </div>
                            <div class="progress rounded-pill" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: @progress%" aria-valuenow="@progress" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                        <!-- Habits List -->
                        <div id="habits-container" class="d-flex flex-column gap-2" style="max-height: 250px; overflow-y: auto;">
                            @if (Model.Habits.Any())
                            {
                                @foreach (var habit in Model.Habits)
                                {
                                    // Visibility Logic:
                                    // 1. Must be after or on StartDate
                                    if (DateTime.Today < habit.StartDate.Date) continue;
                                    
                                    // 2. If Custom, must match today's day of week
                                    if (habit.Frequency == "Custom" && !habit.CustomDays.Contains(DateTime.Today.DayOfWeek)) continue;

                                    <div class="habit-item p-3 rounded-4 bg-light border d-flex align-items-center justify-content-between @(habit.IsCompletedToday ? "border-success bg-success bg-opacity-10" : "")">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="form-check m-0">
                                                <input class="form-check-input" type="checkbox" onchange="toggleHabit(@habit.Id)" @(habit.IsCompletedToday ? "checked" : "") style="cursor: pointer; width: 1.2em; height: 1.2em;">
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark mb-0 form-check-label @(habit.IsCompletedToday ? "text-decoration-line-through text-muted" : "")">@habit.Name</div>
                                                @if (!string.IsNullOrEmpty(habit.Description))
                                                {
                                                    <div class="smaller text-muted">@habit.Description</div>
                                                }
                                                <!-- Debug/Info about schedule -->
                                                <div class="smaller text-muted opacity-75" style="font-size: 0.7rem;">
                                                    <i class="bi bi-calendar-event me-1"></i>
                                                    @(habit.Frequency == "Daily" ? Localizer["Daily"] : string.Join(", ", habit.CustomDays.Select(d => d.ToString().Substring(0, 3))))
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            @if (habit.CurrentStreak > 0)
                                            {
                                                <span class="badge rounded-pill bg-warning text-dark border border-warning shadow-sm" title="@Localizer["Current Streak"]">
                                                    <i class="bi bi-fire me-1 text-danger"></i>@habit.CurrentStreak
                                                </span>
                                            }
                                            <button class="btn btn-link btn-sm text-danger p-0 ms-1 opacity-50 hover-opacity-100" onclick="deleteHabit(@habit.Id)" title="@Localizer["Delete Habit"]">
                                                <i class="bi bi-x-circle-fill"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-4">
                                    <p class="text-muted small mb-0">@Localizer["No habits yet. Start tracking today!"]</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Numbers Card -->
        <div class="col-md-4">



            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-shield-fill-plus"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Emergency Numbers"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Lifeline contacts"]</p>
                            </div>
                        </div>
                    </div>
    
                    <div class="flex-grow-1">
                        <div class="mb-4">
                             <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                                <span class="input-group-text border-0 bg-light px-3"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="emergency-country-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country (e.g. India)"]" oninput="filterEmergencyCountries(this.value)">
                            </div>
                            <div id="emergency-country-list" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; background: white; margin-top: 5px; border: 1px solid #eee;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
    
                        <div id="emergency-display" class="d-none">
                            <div class="text-center mb-3">
                                <img id="emergency-flag" src="" class="shadow-sm rounded-2 mb-2" style="width: 40px; height: 30px; object-fit: cover;">
                                <h6 id="emergency-country-name" class="fw-bold mb-0"></h6>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-shield-shaded text-primary me-3 fs-5"></i>
                                            <span class="fw-medium text-dark">@Localizer["Police"]</span>
                                        </div>
                                        <div id="emer-police" class="h5 fw-bold text-primary mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-danger bg-opacity-10 border border-danger border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-hospital-fill text-danger me-3 fs-5"></i>
                                            <span class="fw-medium text-dark">@Localizer["Ambulance"]</span>
                                        </div>
                                        <div id="emer-ambulance" class="h5 fw-bold text-danger mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-fire text-warning me-3 fs-5"></i>
                                            <span class="fw-medium text-dark">@Localizer["Fire"]</span>
                                        </div>
                                        <div id="emer-fire" class="h5 fw-bold text-warning mb-0">--</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 d-flex justify-content-between align-items-center">
                                         <div class="d-flex align-items-center">
                                            <i class="bi bi-exclamation-triangle-fill text-secondary me-3 fs-5"></i>
                                            <span class="fw-medium text-dark">@Localizer["General"]</span>
                                        </div>
                                        <div id="emer-general" class="h5 fw-bold text-secondary mb-0">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="emergency-placeholder" class="text-center py-4 text-muted opacity-50">
                            <i class="bi bi-globe-americas fs-1 d-block mb-2"></i>
                            <span class="small">@Localizer["Select a country to view numbers"]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Language Translator Module -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%) !important;">
                                <i class="bi bi-translate"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Language Translator"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Instant manual translation"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="mb-3">
                            <textarea id="translator-input" class="form-control rounded-4 bg-light border-0 shadow-sm p-3 small" rows="3" placeholder="@Localizer["Enter text or sentence to translate..."]"></textarea>
                        </div>
                        
                        <div class="d-flex gap-2 mb-3">
                            <select id="translator-target-lang" class="form-select form-select-sm rounded-pill border-0 shadow-sm bg-light px-3" style="font-size: 0.8rem;">
                                <option value="hi" selected>हिन्दी (Hindi)</option>
                                <option value="gu">ગુજરાતી (Gujarati)</option>
                                <option value="en">English</option>
                                <option value="mr">मराठी (Marathi)</option>
                                <option value="bn">বাংলা (Bengali)</option>
                                <option value="es">Español (Spanish)</option>
                                <option value="fr">Français (French)</option>
                                <option value="de">Deutsch (German)</option>
                                <option value="ar">العربية (Arabic)</option>
                                <option value="zh">中文 (Chinese)</option>
                                <option value="ja">日本語 (Japanese)</option>
                                <option value="ru">Русский (Russian)</option>
                                <option value="pt">Português (Portuguese)</option>
                                <option value="it">Italiano (Italian)</option>
                                <option value="ko">한국어 (Korean)</option>
                            </select>
                            <button type="button" onclick="performManualTranslation()" id="translator-btn" class="btn btn-dark rounded-pill px-4 shadow-sm fw-bold small" style="background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%) !important; border: none;">
                                @Localizer["Translate"]
                            </button>
                        </div>

                        <div id="translator-result-container" class="d-none">
                            <div class="p-3 rounded-4 bg-primary bg-opacity-10 border border-primary border-opacity-10 position-relative">
                                <label class="smaller fw-bold text-primary text-uppercase mb-2 d-block ls-1">@Localizer["Translation"]</label>
                                <div id="translator-output" class="text-dark fw-medium" style="white-space: pre-wrap;"></div>
                                <button class="btn btn-link btn-sm position-absolute top-0 end-0 mt-1 me-1 text-primary opacity-50 hover-opacity-100" onclick="copyTranslatedText()" title="@Localizer["Copy"]">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="translator-error" class="alert alert-danger py-2 px-3 rounded-pill smaller d-none mt-2">
                             <i class="bi bi-exclamation-circle me-1"></i> <span id="translator-error-msg"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

</div>


<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="addNoteModalLabel">@Localizer["Add New Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="new-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="saveNewNote()">@Localizer["Save Note"]</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="editNoteModalLabel">@Localizer["Edit Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id" />
                <textarea id="edit-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="updateNote()">@Localizer["Save Changes"]</button>
            </div>
        </div>
    </div>
</div>

    <!-- Add Habit Modal -->
    <div class="modal fade" id="addHabitModal" tabindex="-1" aria-labelledby="addHabitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="addHabitModalLabel">@Localizer["Add New Habit"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="habit-name" class="form-label small fw-bold text-muted">@Localizer["Habit Name"]</label>
                        <input type="text" id="habit-name" class="form-control rounded-pill bg-light border-0 px-3" placeholder="@Localizer["e.g., Drink Water, Read Book"]">
                    </div>
                    <div class="mb-3">
                        <label for="habit-desc" class="form-label small fw-bold text-muted">@Localizer["Description (Optional)"]</label>
                        <input type="text" id="habit-desc" class="form-control rounded-pill bg-light border-0 px-3" placeholder="@Localizer["e.g., 2 liters daily"]">
                    </div>
                     
                    <!-- Frequency Selection -->
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">@Localizer["Frequency"]</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="habitFrequency" id="freqDaily" value="Daily" checked onchange="toggleCustomDays(false)">
                                <label class="form-check-label" for="freqDaily">@Localizer["Daily"]</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="habitFrequency" id="freqCustom" value="Custom" onchange="toggleCustomDays(true)">
                                <label class="form-check-label" for="freqCustom">@Localizer["Custom Days"]</label>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Days Checkboxes -->
                    <div id="customDaysContainer" class="mb-3 d-none p-3 bg-light rounded-4">
                         <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @foreach (DayOfWeek day in Enum.GetValues(typeof(DayOfWeek)))
                            {
                                 // Skip 0 (Sunday) to put it at end if preferred, or just list them. Let's list Mon-Sun or Sun-Sat. Standard Enum is Sun=0.
                                 // Let's rely on standard enum order but maybe display nicer short names.
                                 <div class="form-check form-check-inline">
                                    <input class="form-check-input custom-day-check" type="checkbox" id="day-@day" value="@day">
                                    <label class="form-check-label small" for="day-@day">@day.ToString().Substring(0, 3)</label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Start Date -->
                    <div class="mb-3">
                        <label for="habit-start-date" class="form-label small fw-bold text-muted">@Localizer["Start Date"]</label>
                        <input type="date" id="habit-start-date" class="form-control rounded-pill bg-light border-0 px-3">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="button" class="btn btn-success rounded-pill px-4 text-white fw-bold" onclick="saveNewHabit()">@Localizer["Create Habit"]</button>
                </div>
            </div>
        </div>
    </div>
    


<style>
    /* glass-card moved to site.css for theme support */
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    body {
        min-height: 100vh;
    }
    #timezone-select {
        max-height: 200px;
    }

    /* Currency Enhancements */
    .currency-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .flag-icon {
        width: 20px;
        height: 15px;
        object-fit: cover;
        border-radius: 2px;
    }
    #currency-result {
        background: rgba(25, 135, 84, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }

    /* Time Enhancements */
    #target-time-card {
        transition: all 0.3s ease;
    }
    .badge-today { background-color: #0dcaf0; color: white; }
    .badge-yesterday { background-color: #6c757d; color: white; }
    .badge-tomorrow { background-color: #198754; color: white; }

    /* News Enhancements */
    .object-fit-cover { object-fit: cover; }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .hover-shadow { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .carousel-item { transition: transform 0.6s ease-in-out; }
    .carousel-indicators [data-bs-target] { background-color: #dc3545; }
    .carousel-control-prev-icon, .carousel-control-next-icon { filter: invert(1) grayscale(100); }

    /* Note Enhancements */
    .note-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: default;
    }
    .note-item:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .smaller { font-size: 0.75rem; }
    .ls-1 { letter-spacing: 1px; }

</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

@section Scripts {
    <script src="~/js/emergency_data.js"></script>
    <script>
        // --- Weather Logic ---
        async function detectLocationAndFetchWeather() {
            const content = document.getElementById('weather-content');
            
            // Show detecting spinner
            content.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">@Localizer["Loading..."]</span>
                    </div>
                    <p class="text-secondary fw-medium mb-0">@Localizer["Detecting location..."]</p>
                    <p class="small text-muted">@Localizer["Please allow GPS access if prompted."]</p>
                </div>
            `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeather(`${latitude},${longitude}`);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                        content.innerHTML = `
                            <div class="text-center p-4">
                                <i class="bi bi-geo-alt-fill text-muted fs-1 d-block mb-3"></i>
                                <p class="text-secondary fw-medium mb-0">@Localizer["Location access denied."]</p>
                                <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                            </div>
                        `;
                    },
                    { 
                        timeout: 5000,
                        enableHighAccuracy: true 
                    }
                );
            } else {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-exclamation-circle text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Geolocation not supported."]</p>
                        <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                    </div>
                `;
            }
        }

        async function fetchWeather(location = '') {
            const content = document.getElementById('weather-content');
            
            if (!location) {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-search text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Ready to search."]</p>
                        <p class="small text-muted">@Localizer["Enter a city to see the weather."]</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center p-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="small text-muted">@Localizer["Fetching weather data..."]</span>
                </div>
            `;

            try {
                // Using wttr.in for weather data
                // Forced metric (m) to ensure Celsius and km/h
                const culture = window.APP_CULTURE ? window.APP_CULTURE.split('-')[0] : 'en';
                const response = await fetch(`https://wttr.in/${location || ''}?m&format=j1&lang=${culture}`);
                if (!response.ok) throw new Error('Location not found');
                const data = await response.json();
                
                const current = data?.current_condition?.[0] || {};
                const weatherToday = data?.weather?.[0] || {};
                const astronomy = weatherToday?.astronomy?.[0] || { sunrise: '--', sunset: '--' };
                const area = data?.nearest_area?.[0] || { areaName: [{ value: 'Unknown' }] };
                
                // Safe extraction of precipitation chance
                const chanceOfRain = (weatherToday?.hourly?.[0]?.chanceofrain || '0') + '%';
                
                // Display logic
                let displayName = '';
                if (location && !location.includes(',')) {
                    // Manual city search
                    displayName = location.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                } else {
                    // Coordinates or IP-based detection
                    displayName = area.areaName?.[0]?.value || '@Localizer["Current Location"]';
                }

                const countryName = area.country?.[0]?.value || '';
                const fullLocation = countryName ? `${displayName}, ${countryName}` : displayName;

                const weatherDesc = current?.lang_current?.[0]?.value || current?.weatherDesc?.[0]?.value || '@Localizer["Unknown"]';
                const now = new Date();
                const lastUpdated = now.toLocaleTimeString(window.APP_CULTURE, { hour: '2-digit', minute: '2-digit' });
                
                content.innerHTML = `
                    <div class="weather-main mb-4">
                        <div class="display-4 fw-bold text-primary mb-0">${current?.temp_C || '--'}°C</div>
                        <div class="small fw-semibold text-muted mb-2"><i class="bi bi-thermometer-half"></i> @Localizer["Accurate Celsius"]</div>
                        <div class="fs-5 fw-semibold text-dark text-capitalize lh-sm mb-1">${weatherDesc}</div>
                        <div class="small text-muted mb-2">@Localizer["RealFeel"]: ${current?.FeelsLikeC || '--'}°C</div>
                        ${location && location.includes(',') ? '<div class="badge bg-info bg-opacity-10 text-info mt-1"><i class="bi bi-crosshair me-1"></i> @Localizer["Current Location"]</div>' : ''}
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunrise"]</span>
                                <span class="fw-bold small text-warning"><i class="bi bi-sunrise me-1"></i>${astronomy.sunrise}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunset"]</span>
                                <span class="fw-bold small text-danger"><i class="bi bi-sunset me-1"></i>${astronomy.sunset}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["UV Index"]</span>
                                <span class="fw-bold small text-primary">${current?.uvIndex || '0'}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-info bg-opacity-10 border border-info border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Pressure"]</span>
                                <span class="fw-bold small text-info">${current?.pressure || '--'} hPa</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Humidity"]</span>
                                <span class="fw-bold small text-success">${current?.humidity || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Rain Chance"]</span>
                                <span class="fw-bold small text-warning-emphasis"><i class="bi bi-cloud-rain me-1"></i>${chanceOfRain}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Cloud Cover"]</span>
                                <span class="fw-bold small text-secondary-emphasis"><i class="bi bi-clouds me-1"></i>${current?.cloudcover || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/${encodeURIComponent(fullLocation)}" 
                       target="_blank" 
                       class="location-info p-2 rounded-pill bg-light mb-3 mx-auto d-inline-block px-4 text-decoration-none text-dark hover-link border"
                       title="@Localizer["View on Google Maps"]">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                        <span class="fw-medium">${fullLocation}</span>
                    </a>
                    
                    <div class="d-flex justify-content-between px-3 py-2 border-top mt-2">
                        <div class="text-center">
                            <i class="bi bi-thermometer-low text-primary d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.mintempC || '--'}°C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-thermometer-high text-danger d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.maxtempC || '--'}°C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-wind text-secondary d-block"></i>
                            <span class="smaller fw-bold">${current?.windspeedKmph || '0'} @Localizer["km/h"]</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-eye-fill text-warning d-block"></i>
                            <span class="smaller fw-bold">${current?.visibility || '0'} @Localizer["km"]</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="smaller text-muted" style="font-size: 0.7rem;">
                            <i class="bi bi-arrow-repeat me-1"></i>@Localizer["Last updated:"] ${lastUpdated}
                        </span>
                    </div>
                `;
                // Trigger translation for the weather card content
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(content);
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger py-3 px-3 small rounded-4 mx-2 text-center shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                        <p class="mb-2">@Localizer["Could not load weather for"] "${location}".</p>
                        <button onclick="fetchWeather('${location}')" class="btn btn-danger btn-sm rounded-pill px-4">
                            <i class="bi bi-arrow-clockwise me-1"></i> @Localizer["Retry"]
                        </button>
                    </div>
                `;
                console.error('Weather error:', error);
            }
        }

        function updateWeather() {
            const location = document.getElementById('location-input').value.trim();
            fetchWeather(location);
        }

        // --- Currency Logic ---
        let currencyInfoMap = {};

        async function initCurrencies() {
            try {
                // Fetch exchange rates and country info in parallel
                const [rateRes, countryRes] = await Promise.all([
                    fetch('https://open.er-api.com/v6/latest/USD'),
                    fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2')
                ]);

                const rateData = await rateRes.json();
                const countryData = await countryRes.json();
                
                if (rateData.result === "success") {
                    let currencyOptions = [];

                    // Process country data
                    countryData.forEach(country => {
                        if (country.currencies) {
                            Object.entries(country.currencies).forEach(([code, details]) => {
                                // Include all countries, even if rate is missing
                                currencyOptions.push({
                                    countryName: country.name.common,
                                    countryCode: country.cca2,
                                    currencyCode: code,
                                    currencyName: details.name,
                                    flag: country.flags.svg,
                                    // Unique value for select option to prevent jumping
                                    value: `${code}|${country.cca2}`
                                });

                                // Store info for display
                                currencyInfoMap[`${code}|${country.cca2}`] = {
                                    name: details.name,
                                    symbol: details.symbol,
                                    flag: country.flags.svg,
                                    country: country.name.common
                                };
                            });
                        }
                    });

                    // Sort by country name
                    currencyOptions.sort((a, b) => a.countryName.localeCompare(b.countryName));

                    const fromSelect = document.getElementById('from-currency');
                    const toSelect = document.getElementById('to-currency');
                    
                    const populateSelect = (select, defaultCountryCode, defaultCurrencyCode) => {
                        select.innerHTML = '';
                        let defaultFound = false;
                        
                        currencyOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = `${opt.countryName} - ${opt.currencyName} (${opt.currencyCode})`;
                            select.appendChild(option);

                            // auto-select defaults (US for USD, IN for INR)
                            if (!defaultFound && opt.countryCode === defaultCountryCode && opt.currencyCode === defaultCurrencyCode) {
                                select.value = opt.value;
                                defaultFound = true;
                            }
                        });
                    };

                    populateSelect(fromSelect, 'US', 'USD');
                    populateSelect(toSelect, 'IN', 'INR');
                }
            } catch (error) {
                console.error('Failed to load currencies:', error);
            }
        }

        async function convertCurrency() {
            const amountInput = document.getElementById('amount');
            const amount = amountInput.value || 1;
            // Value format is "CODE|COUNTRY_CODE"
            const fromValue = document.getElementById('from-currency').value;
            const toValue = document.getElementById('to-currency').value;
            
            if (!fromValue || !toValue) return;

            const fromCode = fromValue.split('|')[0];
            const toCode = toValue.split('|')[0];
            
            const resDiv = document.getElementById('currency-result');

            resDiv.innerHTML = `
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="small text-muted">@Localizer["Calculating..."]</span>
                </div>
            `;

            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${fromCode}`);
                const data = await response.json();
                
                if (data.result === "success") {
                    const rate = data.rates[toCode];
                    
                    if (rate !== undefined) {
                        const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        
                        const fromInfo = currencyInfoMap[fromValue];
                        const toInfo = currencyInfoMap[toValue];

                        const symbol = (toInfo.symbol && toInfo.symbol !== 'undefined') ? toInfo.symbol : '';
                        const currencyName = toInfo.currencyName || '';
                        const countryName = toInfo.country || '';
                        
                        resDiv.innerHTML = `
                            <div class="text-start">
                                <div class="small text-muted mb-1">
                                    <img src="${fromInfo.flag}" class="flag-icon me-1" style="width: 20px; height: 15px; vertical-align: middle;">
                                    ${amount} ${fromInfo.country} (${fromCode}) @Localizer["equals"]
                                </div>
                                <div class="h3 fw-bold mb-0">
                                    <img src="${toInfo.flag}" class="flag-icon me-1" style="width: 30px; height: 22px; vertical-align: baseline;">
                                    ${symbol} ${converted} 
                                </div>
                                <div class="fw-medium text-dark small">${currencyName}</div>
                                <div class="small text-muted">@Localizer["in"] ${countryName}</div>
                            </div>
                        `;
                        // Trigger translation for currency result
                        if (window.TranslationManager) {
                            window.TranslationManager.translateElement(resDiv);
                        }
                    } else {
                        resDiv.innerHTML = '<div class="text-warning small text-center"><i class="bi bi-exclamation-circle me-1"></i> @Localizer["Exchange rate unavailable"]</div>';
                        console.warn(`Rate not found for ${toCode}`);
                    }
                } else {
                    resDiv.innerHTML = ''; // Silently fail
                    console.warn('Error fetching rates');
                }
            } catch (error) {
                resDiv.innerHTML = ''; // Silently fail
                console.error('Currency error:', error);
            }
        }

        // --- Time Logic ---
        let currentTargetTimezone = 'UTC';
        let currentTargetLocationName = 'UTC (GMT)';
        const searchCache = new Map(); // Cache for search results

        let searchTimeout;
        async function handleGlobalSearch() {
            const query = document.getElementById('timezone-search').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 3) {
                resultsDiv.classList.add('d-none');
                return;
            }

            // Check Cache
            if (searchCache.has(query.toLowerCase())) {
                renderSearchResults(searchCache.get(query.toLowerCase()));
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    // Single API call for Location + Timezone
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item small text-muted text-center py-3">@Localizer["No location found"]</div>';
                        resultsDiv.classList.remove('d-none');
                        return;
                    }

                    // Cache results
                    searchCache.set(query.toLowerCase(), data.results);
                    renderSearchResults(data.results);

                } catch (error) {
                    console.error('Geo search error:', error);
                }
            }, 300); 
        }

        function renderSearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            const input = document.getElementById('timezone-search');
            
            // --- Auto-select first result (Optimistic) ---
            const first = results[0];
            updateTimezoneFromData(first, false); // Don't update input text yet

            // --- Populate dropdown ---
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('d-none');
            
            results.forEach(item => {
                const name = item.name;
                const country = item.country || '';
                const admin1 = item.admin1 || '';
                const details = [admin1, country].filter(x => x && x !== name).join(', ');
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action small py-2 px-3 border-0';
                btn.innerHTML = `
                    <div class="fw-bold text-start">${name}</div>
                    <div class="smaller text-muted text-start">${details}</div>
                `;
                
                btn.onclick = () => {
                    resultsDiv.classList.add('d-none');
                    input.value = `${name}, ${country}`;
                    updateTimezoneFromData(item, true);
                };
                resultsDiv.appendChild(btn);
            });
            
            // Trigger translation for search results
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(resultsDiv);
            }
        }

        function updateTimezoneFromData(item, updateLabel) {
            if (item.timezone) {
                currentTargetTimezone = item.timezone;
                currentTargetLocationName = `${item.name}, ${item.country || ''}`;
                updateTargetTime();
            }
        }



        function getCurrentCulture() {
            // Prefer TranslationManager's language if available, else fallback to server culture
            if (window.TranslationManager && window.TranslationManager.currentLang) {
                // Formatting needs full locale sometimes, but 'es', 'fr' etc usually work for Date
                return window.TranslationManager.currentLang; 
            }
            return window.APP_CULTURE || 'en-US';
        }

        function updateTimes() {
            const now = new Date();
            const culture = getCurrentCulture();
            document.getElementById('local-time').innerText = now.toLocaleTimeString(culture, { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            updateTargetTime();
        }

        function updateTargetTime() {
            const timezone = currentTargetTimezone;
            const targetTimeDiv = document.getElementById('target-time');
            const targetDateDiv = document.getElementById('target-date');
            const relativeDayDiv = document.getElementById('relative-day');
            const locationDisplay = document.getElementById('target-location-display');

            if (locationDisplay) locationDisplay.innerText = currentTargetLocationName;

            if (!timezone) {
                // ... (fallback)
                return;
            }

            const now = new Date();
            const culture = getCurrentCulture();
            try {
                // Time
                const targetTimeStr = now.toLocaleTimeString(culture, { 
                    timeZone: timezone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true
                });
                targetTimeDiv.innerText = targetTimeStr;

                // Date
                const options = { timeZone: timezone, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const targetDateStr = now.toLocaleDateString(culture, options);
                targetDateDiv.innerText = targetDateStr;

                // Relative Day logic
                const localDateStr = now.toLocaleDateString('en-US'); // Keep calculation logic stable in EN
                const targetDateSimpleStr = now.toLocaleDateString('en-US', { timeZone: timezone });
                
                const localDate = new Date(localDateStr);
                const targetDate = new Date(targetDateSimpleStr);
                
                const diffTime = targetDate - localDate;
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                relativeDayDiv.className = 'badge rounded-pill mt-2';
                let dayText = "";
                if (diffDays === 0) {
                    relativeDayDiv.innerText = "";
                } else if (diffDays > 0) {
                    dayText = "@Localizer["Tomorrow"]";
                    relativeDayDiv.classList.add('badge-tomorrow');
                } else { // diffDays < 0
                    dayText = "@Localizer["Yesterday"]";
                    relativeDayDiv.classList.add('badge-yesterday');
                }
                
                if(dayText) {
                    relativeDayDiv.innerText = dayText;
                    // Trigger dynamic translation only for the relative day badge text
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(relativeDayDiv);
                    }
                }

            } catch (e) {
                targetTimeDiv.innerText = "@Localizer["Error"]";
                targetDateDiv.innerText = "";
                relativeDayDiv.innerText = "";
            }
        }




        // --- News Logic ---
        async function fetchNews(query = '', country = '') {
            if (!country) {
                country = document.getElementById('news-country-select')?.value || 'in';
            }
            const container = document.getElementById('news-container');
            
            // Show loading state
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            try {
                // Using the new GetCityNews for real-time trusted sources
                let url = `/News/GetCityNews?city=${encodeURIComponent(query)}&country=${encodeURIComponent(country)}`;

                const response = await fetch(url); 
                const data = await response.json();
                
                if (data.status === 'ok' && data.articles) {
                    container.innerHTML = '';
                    const articles = data.articles.filter(a => a.title && a.urlToImage).slice(0, 5);
                    
                    if (articles.length === 0) {
                        container.innerHTML = `<p class="small text-muted text-center">@Localizer["No recent news found."]</p>`;
                        return;
                    }

                    let carouselHtml = `
                        <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel" style="width: 100%;">
                            <div class="carousel-inner rounded-3 overflow-hidden">
                    `;

                    articles.forEach((article, index) => {
                        const imgUrl = article.urlToImage || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop';
                        const date = new Date(article.publishedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        
                        carouselHtml += `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <div class="position-relative">
                                    <img src="${imgUrl}" class="d-block w-100 object-fit-cover" alt="News" style="height: 160px;" onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop'">
                                    <div class="position-absolute bottom-0 start-0 w-100 p-2 text-white" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                        <span class="badge bg-danger shadow-sm" style="font-size: 0.6rem;">${article.source.name}</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <h6 class="fw-bold mb-1 line-clamp-2" style="font-size: 0.85rem;">
                                        <a href="${article.url}" target="_blank" class="text-dark text-decoration-none stretched-link">${article.title}</a>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="smaller text-muted">${date}</span>
                                        <span class="badge bg-light text-warning smaller shadow-none border py-0 px-1" style="font-size: 0.6rem;">LIVE</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    carouselHtml += `</div></div>`;
                    container.innerHTML = carouselHtml;
                    
                    // Trigger translation for news container
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(container);
                    }
                }
            } catch (error) {
                console.error('News error:', error);
                container.innerHTML = `<p class="small text-muted text-center">@Localizer["Unable to load news."]</p>`;
            }
        }

        function searchNews() {
            const query = document.getElementById('news-search-input').value.trim();
            const countrySelect = document.getElementById('news-country-select');
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            
            if (query) {
                // Redirect to the dedicated City News page with both parameters
                window.location.href = `/News/CityNews?city=${encodeURIComponent(query)}&country=${encodeURIComponent(countryName)}`;
            } else {
                // If query is empty, just refresh the widget with the selected country
                fetchNews('', countrySelect.value);
            }
        }

        async function saveNewNote() {
            const text = document.getElementById('new-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/AddNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Add note error:', error);
            }
        }

        function openEditModal(id, text) {
            document.getElementById('edit-note-id').value = id;
            document.getElementById('edit-note-text').value = text;
            const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            modal.show();
        }

        async function updateNote() {
            const id = document.getElementById('edit-note-id').value;
            const text = document.getElementById('edit-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/EditNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}&text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Update note error:', error);
            }
        }

        // --- World Countries logic ---
        let allCountries = [];

        async function fetchAllCountries() {
            const container = document.getElementById('country-container');
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,translations');
                if (!response.ok) throw new Error('API failed');
                allCountries = await response.json();
                
                 // Helper to get name in current language
                allCountries.forEach(c => {
                    c.displayName = getTranslatedCountryName(c);
                });

                // Sort alphabetically
                allCountries.sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                renderCountryList(allCountries);
            } catch (error) {
                console.error('Fetch all countries error:', error);
                if (container) container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('ErrorLoadDir')}</div>`;
            }
        }
        
        
        const uiLabels = {
            'en': { 'Capital': 'Capital', 'Population': 'Population', 'Currency': 'Currency', 'Timezone': 'Timezone', 'Language': 'Language', 'Loading': 'Loading...', 'Back': 'Back', 'NA': 'N/A', 'SearchPlaceholder': 'Search country...', 'NoResults': 'No results found.', 'ErrorLoadDir': 'Unable to load directory.', 'ErrorLoadDetails': 'Unable to load details.' },
            'hi': { 'Capital': 'राजधानी', 'Population': 'जनसंख्या', 'Currency': 'मुद्रा', 'Timezone': 'समय क्षेत्र', 'Language': 'भाषा', 'Loading': 'लोड हो रहा है...', 'Back': 'वापस', 'NA': 'लागू नहीं', 'SearchPlaceholder': 'देश खोजें...', 'NoResults': 'कोई परिणाम नहीं मिला।', 'ErrorLoadDir': 'निर्देशिका लोड करने में असमर्थ।', 'ErrorLoadDetails': 'विवरण लोड करने में असमर्थ।' },
            'gu': { 'Capital': 'પાટનગર', 'Population': 'વસ્તી', 'Currency': 'ચલણ', 'Timezone': 'સમય ક્ષેત્ર', 'Language': 'ભાષા', 'Loading': 'લોડ થઈ રહ્યું છે...', 'Back': 'પાછા', 'NA': 'લાગુ નથી', 'SearchPlaceholder': 'દેશ શોધો...', 'NoResults': 'કોઈ પરિણામો મળ્યા નથી.', 'ErrorLoadDir': 'ડિરેક્ટરી લોડ કરવામાં અસમર્થ.', 'ErrorLoadDetails': 'વિગતો લોડ કરવામાં અસમર્થ.' },
            'bn': { 'Capital': 'রাজধানী', 'Population': 'জনসংখ্যা', 'Currency': 'মুদ্রা', 'Timezone': 'সময় অঞ্চল', 'Language': 'ভাষা', 'Loading': 'লোড হচ্ছে...', 'Back': 'ফিরে যান', 'NA': 'প্রযোজ্য নয়', 'SearchPlaceholder': 'দেশ খুঁজুন...', 'NoResults': 'কোন ফলাফল পাওয়া যায়নি।', 'ErrorLoadDir': 'ডিরেক্টরি লোড করতে অক্ষম।', 'ErrorLoadDetails': 'বিবরণ লোড করতে অক্ষম।' },
            'te': { 'Capital': 'రాజధాని', 'Population': 'జనాభా', 'Currency': 'కరెన్సీ', 'Timezone': 'సమయ మండలి', 'Language': 'భాష', 'Loading': 'లోడ్ అవుతోంది...', 'Back': 'వెనుకకు', 'NA': 'వర్తించదు', 'SearchPlaceholder': 'దేశాన్ని వెతకండి...', 'NoResults': 'ఫలితాలు కనుగొనబడలేదు.', 'ErrorLoadDir': 'డైరెక్టరీని లోడ్ చేయలేకపోయింది.', 'ErrorLoadDetails': 'వివరాలను లోడ్ చేయలేకపోయింది.' },
            'ta': { 'Capital': 'தலைநகரம்', 'Population': 'மக்கள் தொகை', 'Currency': 'நாணயம்', 'Timezone': 'நேர மண்டலம்', 'Language': 'மொழி', 'Loading': 'ஏற்றப்படுகிறது...', 'Back': 'பின்னால்', 'NA': 'பொருந்தாது', 'SearchPlaceholder': 'நாட்டைத் தேடுங்கள்...', 'NoResults': 'முடிவுகள் எதுவும் காணப்படவில்லை.', 'ErrorLoadDir': 'அடைவை ஏற்ற முடியவில்லை.', 'ErrorLoadDetails': 'விவரங்களை ஏற்ற முடியவில்லை.' },
            'mr': { 'Capital': 'राजधानी', 'Population': 'लोकसंख्या', 'Currency': 'चलन', 'Timezone': 'वेळ क्षेत्र', 'Language': 'भाषा', 'Loading': 'लोड होत आहे...', 'Back': 'मागे', 'NA': 'लागू नाही', 'SearchPlaceholder': 'देश शोधा...', 'NoResults': 'काहीही सापडले नाही.', 'ErrorLoadDir': 'निर्देशिका लोड करण्यात अक्षम.', 'ErrorLoadDetails': 'तपशील लोड करण्यात अक्षम.' },
            'kn': { 'Capital': 'ರಾಜಧಾನಿ', 'Population': 'ಜನಸಂಖ್ಯೆ', 'Currency': 'ಕರೆನ್ಸಿ', 'Timezone': 'ಸಮಯ ವಲಯ', 'Language': 'ಭಾಷೆ', 'Loading': 'ಲೋಡ್ ಆಗುತ್ತಿದೆ...', 'Back': 'ಹಿಂದೆ', 'NA': 'ಅನ್ವಯಿಸುವುದಿಲ್ಲ', 'SearchPlaceholder': 'ದೇಶವನ್ನು ಹುಡುಕಿ...', 'NoResults': 'ಯಾವುದೇ ಫಲಿತಾಂಶಗಳು ಕಂಡುಬಂದಿಲ್ಲ.', 'ErrorLoadDir': 'ಡೈರೆಕ್ಟರಿಯನ್ನು ಲೋಡ್ ಮಾಡಲು ಸಾಧ್ಯವಿಲ್ಲ.', 'ErrorLoadDetails': 'ವಿವರಗಳನ್ನು ಲೋಡ್ ಮಾಡಲು ಸಾಧ್ಯವಿಲ್ಲ.' },
            'ml': { 'Capital': 'തലസ്ഥാനം', 'Population': 'ജനസംഖ്യ', 'Currency': 'കറൻസി', 'Timezone': 'സമയ മേഖല', 'Language': 'ഭാഷ', 'Loading': 'ലോഡുചെയ്യുന്നു...', 'Back': 'തിരികെ', 'NA': 'ബാധകമല്ല', 'SearchPlaceholder': 'രാജ്യം തിരയുക...', 'NoResults': 'ഫലങ്ങളൊന്നും കണ്ടെത്തിയില്ല.', 'ErrorLoadDir': 'ഡയറക്ടറി ലോഡുചെയ്യുന്നതിന് കഴിഞ്ഞില്ല.', 'ErrorLoadDetails': 'വിശദാംശങ്ങൾ ലോഡുചെയ്യുന്നതിന് കഴിഞ്ഞില്ല.' },
            'pa': { 'Capital': 'ਰਾਜਧਾਨੀ', 'Population': 'ਆਬਾਦੀ', 'Currency': 'ਮੁਦਰਾ', 'Timezone': 'ਸਮਾਂ ਖੇਤਰ', 'Language': 'ਭਾਸ਼ਾ', 'Loading': 'ਲੋਡ ਹੋ ਰਿਹਾ ਹੈ...', 'Back': 'ਵਾਪਸ', 'NA': 'ਲਾਗੂ ਨਹੀਂ', 'SearchPlaceholder': 'ਦੇਸ਼ ਖੋਜੋ...', 'NoResults': 'ਕੋਈ ਨਤੀਜਾ ਨਹੀਂ ਮਿਲਿਆ।', 'ErrorLoadDir': 'ਡਾਇਰੈਕਟਰੀ ਲੋਡ ਕਰਨ ਵਿੱਚ ਅਸਮਰੱਥ।', 'ErrorLoadDetails': 'ਵੇਰਵੇ ਲੋਡ ਕਰਨ ਵਿੱਚ ਅਸਮਰੱਥ।' },
            'ur': { 'Capital': 'دارالحکومت', 'Population': 'آبادی', 'Currency': 'کرنسی', 'Timezone': 'ٹائم زون', 'Language': 'زبان', 'Loading': 'لوڈ ہو رہا ہے...', 'Back': 'واپس', 'NA': 'لاگو نہیں', 'SearchPlaceholder': 'ملک تلاش کریں...', 'NoResults': 'کوئی نتائج نہیں ملے۔', 'ErrorLoadDir': 'ڈائرکٹری لوڈ کرنے سے قاصر۔', 'ErrorLoadDetails': 'تفصیلات لوڈ کرنے سے قاصر۔' }
        };

        function getUiLabel(key) {
            const culture = window.APP_CULTURE || 'en-US';
            const langCode = culture.split('-')[0];
            const labels = uiLabels[langCode] || uiLabels['en'];
            return labels[key] || key;
        }

        function getTranslatedCountryName(country) {
            const culture = window.APP_CULTURE || 'en-US';
            const langCode = culture.split('-')[0]; // e.g., 'hi' from 'hi-IN'
            
            // Map ISO 639-1 (2 char) to RestCountries translation keys (3 char mostly)
            const langMap = {
                'hi': 'hin', 'gu': 'guj', 'bn': 'ben', 'ta': 'tam', 
                'te': 'tel', 'kn': 'kan', 'ml': 'mal', 'mr': 'mar', 
                'pa': 'pan', 'ur': 'urd', 'fr': 'fra', 'es': 'spa',
                'de': 'deu', 'it': 'ita', 'pt': 'por', 'ru': 'rus',
                'ja': 'jpn', 'zh': 'zho', 'ar': 'ara'
            };
            
            const trKey = langMap[langCode];
            if (trKey && country.translations && country.translations[trKey]) {
                return country.translations[trKey].common;
            }
            return country.name.common;
        }

        function renderCountryList(list) {
            const container = document.getElementById('country-container');
            const searchIcon = document.getElementById('country-search-icon');
            
            // Set icon to search by default
            const searchInput = document.getElementById('country-search-input');
            if (searchInput) {
                searchInput.placeholder = getUiLabel('SearchPlaceholder');
            }

            if (searchIcon) {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null; // Reset to default if it was "X"
            }

            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('NoResults')}</div>`;
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            list.forEach(c => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action d-flex align-items-center bg-transparent border-0 py-2 px-1" onclick="showCountryDetail('${c.cca3}')">
                        <img src="${c.flags.svg}" class="rounded-1 me-3 shadow-sm" style="width: 30px; height: 20px; object-fit: cover;">
                        <span class="small fw-medium">${c.displayName}</span>
                        <i class="bi bi-chevron-right ms-auto smaller text-muted opacity-50"></i>
                    </button>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // Trigger translation for country list
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(container);
            }
        }

        function filterCountries(query) {
            const searchIcon = document.getElementById('country-search-icon');
            if (query.trim()) {
                searchIcon.className = 'bi bi-x-lg';
                searchIcon.parentElement.onclick = showCountryList;
            } else {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null;
            }

            const filtered = allCountries.filter(c => 
                c.displayName.toLowerCase().includes(query.toLowerCase())
            );
            renderCountryList(filtered);
        }

        function showCountryList() {
            document.getElementById('country-search-input').value = '';
            renderCountryList(allCountries);
        }

        async function showCountryDetail(cca3) {
            const container = document.getElementById('country-container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                        <span class="visually-hidden">${getUiLabel('Loading')}</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`https://restcountries.com/v3.1/alpha/${cca3}`);
                if (!response.ok) throw new Error('Details not found');
                const data = await response.json();
                const country = data[0];

                const name = getTranslatedCountryName(country);
                const flag = country.flags.svg;
                const capital = country.capital ? country.capital[0] : getUiLabel('NA');
                const region = country.region;
                const population = country.population.toLocaleString(window.APP_CULTURE);
                const currencies = country.currencies ? Object.values(country.currencies).map(c => `${c.name} (${c.symbol})`).join(', ') : getUiLabel('NA');
                const languages = country.languages ? Object.values(country.languages).join(', ') : getUiLabel('NA');
                const timezones = country.timezones ? country.timezones[0] : getUiLabel('NA');

                container.innerHTML = `
                    <div class="country-details mt-2">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" onclick="showCountryList()" style="font-size: 0.7rem;">
                                <i class="bi bi-arrow-left me-1"></i> ${getUiLabel('Back')}
                            </button>
                        </div>
                        <div class="text-center mb-3">
                            <img src="${flag}" class="shadow-sm rounded-3" style="width: 100%; max-height: 120px; object-fit: cover; border: 1px solid #eee;">
                            <h5 class="fw-bold mt-2 mb-0">${name}</h5>
                            <span class="badge bg-light text-dark border smaller">${region}</span>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Capital')}</span>
                                    <span class="fw-bold small text-dark">${capital}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Population')}</span>
                                    <span class="fw-bold small text-dark">${population}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Currency')}</span>
                                    <span class="fw-bold small text-dark" style="font-size: 0.65rem;">${currencies}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Timezone')}</span>
                                    <span class="fw-bold small text-dark">${timezones}</span>
                                </div>
                            </div>
                            <div class="col-12 mt-1">
                                <div class="p-2 rounded-3 bg-light border text-center">
                                    <span class="d-block smaller text-muted">${getUiLabel('Language')}</span>
                                    <span class="fw-bold small text-dark">${languages}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.scrollTop = 0; // Reset scroll
                // Trigger translation for country details
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(container);
                }
            } catch (error) {
                console.error('Country details error:', error);
                container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('ErrorLoadDetails')}</div>`;
            }
        }


        async function deleteNote(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this note?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete note error:', error);
            }
        }

        // --- Habit Logic ---
        function toggleCustomDays(show) {
            const container = document.getElementById('customDaysContainer');
            if (show) {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        }

        async function saveNewHabit() {
            const name = document.getElementById('habit-name').value;
            const desc = document.getElementById('habit-desc').value;
            const startDate = document.getElementById('habit-start-date').value;
            
            const isCustom = document.getElementById('freqCustom').checked;
            const frequency = isCustom ? "Custom" : "Daily";
            
            let customDays = [];
            if (isCustom) {
                document.querySelectorAll('.custom-day-check:checked').forEach(cb => {
                    customDays.push(cb.value);
                });
            }

            if (!name.trim()) return;

            try {
                const response = await fetch('/Dashboard/AddHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}&frequency=${frequency}&customDays=${customDays.join(',')}&startDate=${startDate}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Add habit error:', error);
            }
        }

        async function toggleHabit(id) {
            try {
                const response = await fetch('/Dashboard/ToggleHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Toggle habit error:', error);
            }
        }

        async function deleteHabit(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this habit?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteHabit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete habit error:', error);
            }
        }

        // --- Emergency Numbers Logic ---
        let emergencyCountries = []; // Will share structure with allCountries roughly

        async function initEmergencySection() {
            // Need country list. If fetchAllCountries already ran, use it.
            // If strictly needed, wait or check. 
            // We can reuse 'allCountries' from World Countries logic if confirmed loaded
            // Or just check if empty and re-fetch if needed.
            
            if (allCountries.length === 0) {
              // Should be loaded by fetchAllCountries, but let's be safe
               try {
                  const response = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,translations'); 
                  const data = await response.json();
                  emergencyCountries = data.sort((a, b) => a.name.common.localeCompare(b.name.common));
               } catch(e) { console.error(e); }
            } else {
                emergencyCountries = allCountries;
            }
        }

        function filterEmergencyCountries(query) {
             const listDiv = document.getElementById('emergency-country-list');
             if (!query || query.length < 2) {
                 listDiv.classList.add('d-none');
                 return;
             }
             
             // Use same translation helper
             const filtered = emergencyCountries.filter(c => {
                 const name = getTranslatedCountryName(c);
                 return name.toLowerCase().includes(query.toLowerCase());
             }).slice(0, 5); // Limit to 5
             
             if (filtered.length === 0) {
                 listDiv.innerHTML = `<div class="p-2 small text-muted text-center">@Localizer["No results"]</div>`;
                 listDiv.classList.remove('d-none');
                 return;
             }
             
             let html = '';
             filtered.forEach(c => {
                 const name = getTranslatedCountryName(c);
                 html += `
                    <button type="button" class="list-group-item list-group-item-action border-0 px-3 py-2 d-flex align-items-center" onclick="selectEmergencyCountry('${c.cca3}', '${name.replace(/'/g, "\\'")}', '${c.flags.svg}')">
                        <img src="${c.flags.svg}" class="me-2 rounded-1 border" style="width: 20px; height: 15px; object-fit: cover;">
                        <span class="small fw-medium">${name}</span>
                    </button>
                 `;
             });
             
             listDiv.innerHTML = html;
             listDiv.classList.remove('d-none');
        }

        async function performManualTranslation() {
            const input = document.getElementById('translator-input').value.trim();
            const targetLang = document.getElementById('translator-target-lang').value;
            const btn = document.getElementById('translator-btn');
            const errorDiv = document.getElementById('translator-error');
            const resultContainer = document.getElementById('translator-result-container');
            const outputDiv = document.getElementById('translator-output');

            errorDiv.classList.add('d-none');
            
            if (!input) {
                document.getElementById('translator-error-msg').innerText = "@Localizer["Please enter some text to translate."]";
                errorDiv.classList.remove('d-none');
                return;
            }

            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> @Localizer["Translating..."]';
            btn.disabled = true;

            try {
                const response = await fetch('/api/translation/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ texts: [input], targetLanguage: targetLang })
                });

                if (response.ok) {
                    const result = await response.json();
                    const translatedText = result[input];
                    if (translatedText) {
                        outputDiv.innerText = translatedText;
                        resultContainer.classList.remove('d-none');
                        // Scroll to result if on mobile
                        if (window.innerWidth < 768) {
                            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    } else {
                        throw new Error("Translation failed");
                    }
                } else {
                    throw new Error("Request failed");
                }
            } catch (error) {
                console.error("Manual translation error:", error);
                document.getElementById('translator-error-msg').innerText = "@Localizer["Translation failed. Please try again later."]";
                errorDiv.classList.remove('d-none');
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        function copyTranslatedText() {
            const text = document.getElementById('translator-output').innerText;
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback
                    const btn = document.querySelector('[onclick="copyTranslatedText()"] i');
                    btn.className = 'bi bi-check-lg';
                    setTimeout(() => {
                        btn.className = 'bi bi-clipboard';
                    }, 2000);
                });
            }
        }

        function selectEmergencyCountry(cca3, name, flagUrl) {

            document.getElementById('emergency-country-search').value = name;
            document.getElementById('emergency-country-list').classList.add('d-none');
            
            document.getElementById('emergency-country-name').innerText = name;
            document.getElementById('emergency-flag').src = flagUrl;
            
            const data = window.emergencyData[cca3] || { police: '112', ambulance: '112', fire: '112', general: '112' }; // Fallback to 112 (EU/GSM standard)
            
            // Check if specific data exists, if not maybe show "Not available" or standard
            // My data set covers major ones.
            
            document.getElementById('emer-police').innerText = data.police || '--';
            document.getElementById('emer-ambulance').innerText = data.ambulance || '--';
            document.getElementById('emer-fire').innerText = data.fire || '--';
            document.getElementById('emer-general').innerText = data.general || '--';
            
            document.getElementById('emergency-placeholder').classList.add('d-none');
            document.getElementById('emergency-display').classList.remove('d-none');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ... existing listeners
            setTimeout(initEmergencySection, 2000); // Give time for main country fetch
            detectLocationAndFetchWeather(); // Detect and fetch
            initCurrencies();
            // initTimezones(); REMOVED
            window.timeUpdateInterval = setInterval(updateTimes, 1000);
            
            // Auto-refresh weather every 10 minutes ONLY if we have a location
            if (window.weatherRefreshInterval) clearInterval(window.weatherRefreshInterval);
            window.weatherRefreshInterval = setInterval(() => {
                const currentLoc = document.querySelector('.location-info .fw-medium')?.innerText;
                if (currentLoc) {
                    // Refresh current displayed location
                    fetchWeather(currentLoc);
                } else {
                    // Try to re-detect if nothing is shown
                    detectLocationAndFetchWeather();
                }
            }, 10 * 60 * 1000);
            
            updateTimes();
            // Initial conversion delayed slightly to allow currencies to load
            setTimeout(convertCurrency, 1000);
            
            fetchNews();
            fetchAllCountries();
            // Start listening for clicks outside to close dropdowns
            document.addEventListener('click', function(event) {
                const eList = document.getElementById('emergency-country-list');
                const eInput = document.getElementById('emergency-country-search');
                if (eList && !eList.contains(event.target) && event.target !== eInput) {
                    eList.classList.add('d-none');
                }
            });
        });
    </script>
}
