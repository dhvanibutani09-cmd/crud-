@model DashboardViewModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Dashboard"];
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 text-dark">
        <h1 class="mb-0">@Localizer["Welcome"], @(User.FindFirst(System.Security.Claims.ClaimTypes.GivenName)?.Value ?? User.Identity?.Name)!</h1>
        <a asp-controller="User" asp-action="Index" class="btn btn-outline-dark rounded-pill px-4">
            <i class="bi bi-people-fill me-2"></i> @Localizer["Manage Users"]
        </a>
    </div>
    
    <div class="row g-4">
        <!-- Weather Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-cloud-sun-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Weather Details"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Real-time climate"]</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-grow-1">
                        <div id="weather-content" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">@Localizer["Loading..."]</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="location-input" class="form-control border-0 px-3" placeholder="@Localizer["Search city..."]" onkeydown="if(event.key==='Enter'){event.preventDefault(); updateWeather();}">
                            <button type="button" onclick="updateWeather()" class="btn btn-primary border-0 px-3">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currency Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-success text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-currency-exchange"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Currency Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Global exchange rates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="input-group input-group-sm mb-3 shadow-sm rounded-pill overflow-hidden">
                            <span class="input-group-text border-0 bg-light px-3 small">@Localizer["Amount"]</span>
                            <input type="number" id="amount" class="form-control border-0 text-center fw-bold" value="1">
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <select id="from-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="USD" selected>USD</option>
                                </select>
                            </div>
                            <div class="col">
                                <select id="to-currency" class="form-select form-select-sm border-0 bg-light rounded-pill shadow-sm px-3">
                                    <option value="INR" selected>INR</option>
                                </select>
                            </div>
                        </div>
                        <div id="currency-result" class="text-center py-3 bg-success bg-opacity-10 rounded-4 border border-success border-opacity-10 mb-3" style="min-height: 80px;"></div>
                    </div>

                    <button onclick="convertCurrency()" class="btn btn-success w-100 rounded-pill shadow-sm fw-bold py-2 mt-auto">
                        <i class="bi bi-arrow-repeat me-2"></i>@Localizer["Convert"]
                    </button>
                </div>
            </div>
        </div>

        <!-- Time Conversion Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card overflow-visible">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-info text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-clock-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Time Conversion"]</h6>
                                <p class="text-muted small mb-0">@Localizer["World clock"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-grow-1">
                        <div class="text-center mb-4 p-3 bg-light rounded-4 border">
                            <label class="form-label smaller text-muted text-uppercase fw-bold mb-2 ls-1">@Localizer["Current Local Time"]</label>
                            <div id="local-time" class="fw-bold fs-2 text-info"></div>
                        </div>

                        <div class="position-relative mb-4">
                            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border">
                                <span class="input-group-text border-0 bg-white ps-3"><i class="bi bi-search text-muted"></i></span>
                                <input type="text" id="timezone-search" class="form-control border-0 px-2" placeholder="@Localizer["Search country, city..."]" oninput="handleGlobalSearch()">
                            </div>
                            <div id="search-results" class="list-group list-group-flush shadow-sm rounded-4 overflow-hidden d-none" style="position: absolute; width:100%; z-index: 1000; max-height: 200px; overflow-y: auto; background: white; margin-top: 5px; border: 1px solid #eee;">
                            </div>
                        </div>

                        <div id="target-time-card" class="p-3 bg-info bg-opacity-10 border border-info border-opacity-10 rounded-4 text-center">
                            <div id="target-location-display" class="smaller fw-bold text-dark text-uppercase mb-1 ls-1">UTC (GMT)</div>
                            <div id="target-time" class="fw-bold fs-3 text-info">-- : -- : --</div>
                            <div id="target-date" class="smaller fw-medium mt-1"></div>
                            <div id="relative-day" class="badge rounded-pill mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- News Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-danger text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-newspaper"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Headlines"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Latest world updates"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex gap-2">
                            <select id="news-country-select" class="form-select form-select-sm rounded-pill border-0 shadow-sm bg-light px-3" style="font-size: 0.8rem; width: auto;" onchange="fetchNews(document.getElementById('news-search-input').value, this.value)">
                                <option value="us">@Localizer["USA"]</option>
                                <option value="in" selected>@Localizer["India"]</option>
                                <option value="gb">@Localizer["UK"]</option>
                                <option value="ca">@Localizer["Canada"]</option>
                                <option value="au">@Localizer["Australia"]</option>
                                <option value="ae">@Localizer["UAE"]</option>
                            </select>
                            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden flex-grow-1">
                                <input type="text" id="news-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search news..."]" style="font-size: 0.8rem;" onkeydown="if(event.key==='Enter'){event.preventDefault(); searchNews();}">
                                <button type="button" onclick="searchNews()" class="btn btn-danger border-0 px-3">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="news-container" class="flex-grow-1 d-flex align-items-center justify-content-center">
                        <div class="text-center py-4">
                            <div class="spinner-border text-danger spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">@Localizer["Fetching news..."]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Country Search Card -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem; background-color: #6610f2 !important;">
                                <i class="bi bi-globe"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["World Countries"]</h6>
                                <p class="text-muted small mb-0">@Localizer["All Country Details"]</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden">
                            <input type="text" id="country-search-input" class="form-control border-0 px-3" placeholder="@Localizer["Search country..."]" oninput="filterCountries(this.value)">
                            <button type="button" onclick="showCountryList()" class="btn btn-primary border-0 px-3" style="background-color: #6610f2 !important;">
                                <i class="bi bi-x-lg" id="country-search-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="country-container" class="flex-grow-1 overflow-auto" style="max-height: 350px;">
                        <div class="text-center py-5">
                            <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notes Card (New Widget) -->
        <div class="col-md-4">
            <div class="card h-100 shadow border-0 rounded-4 glass-card">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-warning text-white me-3" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                <i class="bi bi-sticky-fill"></i>
                            </div>
                            <div>
                                <h6 class="card-title fw-bold mb-0">@Localizer["Personal Notes"]</h6>
                                <p class="text-muted small mb-0">@Localizer["Capture your thoughts"]</p>
                            </div>
                        </div>
                        <button class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold text-white" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="bi bi-plus-lg me-2"></i> @Localizer["Add Note"]
                        </button>
                    </div>

                    <div id="notes-container" class="row g-3">
                        @if (Model.Notes.Any())
                        {
                            @foreach (var note in Model.Notes)
                            {
                                <div class="col-12">
                                    <div class="note-item h-100 p-3 rounded-4 bg-warning bg-opacity-10 border border-warning border-opacity-25 shadow-sm d-flex flex-column">
                                        <div class="p-2 flex-grow-1 text-dark small" style="white-space: pre-wrap; font-family: 'Inter', sans-serif;">@note.Text</div>
                                        <div class="mt-3 pt-3 border-top border-warning border-opacity-10 d-flex justify-content-between align-items-center">
                                            <span class="smaller text-muted">
                                                <i class="bi bi-clock me-1"></i> @note.CreatedAt.ToString("MMM dd, HH:mm")
                                            </span>
                                            <div class="btn-group">
                                                <button class="btn btn-link btn-sm text-dark p-0 me-2" onclick="openEditModal(@note.Id, `@note.Text.Replace("`", "\\`")`)"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteNote(@note.Id)"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12 text-center py-5">
                                <div class="text-muted mb-2 opacity-25"><i class="bi bi-journal-text" style="font-size: 3rem;"></i></div>
                                <p class="text-muted">@Localizer["No notes yet. Click 'Add Note' to start writing."]</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="addNoteModalLabel">@Localizer["Add New Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="new-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="saveNewNote()">@Localizer["Save Note"]</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Note Modal -->
<div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="editNoteModalLabel">@Localizer["Edit Note"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-note-id" />
                <textarea id="edit-note-text" class="form-control rounded-4 border-0 bg-light p-3" rows="5" placeholder="@Localizer["Type your note here..."]"></textarea>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                <button type="button" class="btn btn-warning rounded-pill px-4 text-white fw-bold" onclick="updateNote()">@Localizer["Save Changes"]</button>
            </div>
        </div>
    </div>
</div>
    


<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
    }
    .glass-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(0,0,0,0.2) !important;
        background: rgba(255, 255, 255, 0.8);
    }
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
    }
    body {
        min-height: 100vh;
    }
    #timezone-select {
        max-height: 200px;
    }

    /* Currency Enhancements */
    .currency-option {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .flag-icon {
        width: 20px;
        height: 15px;
        object-fit: cover;
        border-radius: 2px;
    }
    #currency-result {
        background: rgba(25, 135, 84, 0.1);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }

    /* Time Enhancements */
    #target-time-card {
        transition: all 0.3s ease;
    }
    .badge-today { background-color: #0dcaf0; color: white; }
    .badge-yesterday { background-color: #6c757d; color: white; }
    .badge-tomorrow { background-color: #198754; color: white; }

    /* News Enhancements */
    .object-fit-cover { object-fit: cover; }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .hover-shadow { transition: transform 0.2s, box-shadow 0.2s; }
    .hover-shadow:hover { transform: translateY(-3px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
    .carousel-item { transition: transform 0.6s ease-in-out; }
    .carousel-indicators [data-bs-target] { background-color: #dc3545; }
    .carousel-control-prev-icon, .carousel-control-next-icon { filter: invert(1) grayscale(100); }

    /* Note Enhancements */
    .note-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: default;
    }
    .note-item:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .smaller { font-size: 0.75rem; }
    .ls-1 { letter-spacing: 1px; }

</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

@section Scripts {
    <script>
        // --- Weather Logic ---
        async function detectLocationAndFetchWeather() {
            const content = document.getElementById('weather-content');
            
            // Show detecting spinner
            content.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">@Localizer["Loading..."]</span>
                    </div>
                    <p class="text-secondary fw-medium mb-0">@Localizer["Detecting location..."]</p>
                    <p class="small text-muted">@Localizer["Please allow GPS access if prompted."]</p>
                </div>
            `;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        fetchWeather(`${latitude},${longitude}`);
                    },
                    (error) => {
                        console.warn('Geolocation error:', error.message);
                        content.innerHTML = `
                            <div class="text-center p-4">
                                <i class="bi bi-geo-alt-fill text-muted fs-1 d-block mb-3"></i>
                                <p class="text-secondary fw-medium mb-0">@Localizer["Location access denied."]</p>
                                <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                            </div>
                        `;
                    },
                    { 
                        timeout: 5000,
                        enableHighAccuracy: true 
                    }
                );
            } else {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-exclamation-circle text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Geolocation not supported."]</p>
                        <p class="small text-muted">@Localizer["Please search for your city manually above."]</p>
                    </div>
                `;
            }
        }

        async function fetchWeather(location = '') {
            const content = document.getElementById('weather-content');
            
            if (!location) {
                content.innerHTML = `
                    <div class="text-center p-4">
                        <i class="bi bi-search text-muted fs-1 d-block mb-3"></i>
                        <p class="text-secondary fw-medium mb-0">@Localizer["Ready to search."]</p>
                        <p class="small text-muted">@Localizer["Enter a city to see the weather."]</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center p-4">
                    <div class="spinner-border text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="small text-muted">@Localizer["Fetching weather data..."]</span>
                </div>
            `;

            try {
                // Using wttr.in for weather data
                // Forced metric (m) to ensure Celsius and km/h
                const culture = window.APP_CULTURE ? window.APP_CULTURE.split('-')[0] : 'en';
                const response = await fetch(`https://wttr.in/${location || ''}?m&format=j1&lang=${culture}`);
                if (!response.ok) throw new Error('Location not found');
                const data = await response.json();
                
                const current = data?.current_condition?.[0] || {};
                const weatherToday = data?.weather?.[0] || {};
                const astronomy = weatherToday?.astronomy?.[0] || { sunrise: '--', sunset: '--' };
                const area = data?.nearest_area?.[0] || { areaName: [{ value: 'Unknown' }] };
                
                // Safe extraction of precipitation chance
                const chanceOfRain = (weatherToday?.hourly?.[0]?.chanceofrain || '0') + '%';
                
                // Display logic
                let displayName = '';
                if (location && !location.includes(',')) {
                    // Manual city search
                    displayName = location.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                } else {
                    // Coordinates or IP-based detection
                    displayName = area.areaName?.[0]?.value || '@Localizer["Current Location"]';
                }

                const countryName = area.country?.[0]?.value || '';
                const fullLocation = countryName ? `${displayName}, ${countryName}` : displayName;

                const weatherDesc = current?.lang_current?.[0]?.value || current?.weatherDesc?.[0]?.value || '@Localizer["Unknown"]';
                const now = new Date();
                const lastUpdated = now.toLocaleTimeString(window.APP_CULTURE, { hour: '2-digit', minute: '2-digit' });
                
                content.innerHTML = `
                    <div class="weather-main mb-4">
                        <div class="display-4 fw-bold text-primary mb-0">${current?.temp_C || '--'}째C</div>
                        <div class="small fw-semibold text-muted mb-2"><i class="bi bi-thermometer-half"></i> @Localizer["Accurate Celsius"]</div>
                        <div class="fs-5 fw-semibold text-dark text-capitalize lh-sm mb-1">${weatherDesc}</div>
                        <div class="small text-muted mb-2">@Localizer["RealFeel"]: ${current?.FeelsLikeC || '--'}째C</div>
                        ${location && location.includes(',') ? '<div class="badge bg-info bg-opacity-10 text-info mt-1"><i class="bi bi-crosshair me-1"></i> @Localizer["Current Location"]</div>' : ''}
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunrise"]</span>
                                <span class="fw-bold small text-warning"><i class="bi bi-sunrise me-1"></i>${astronomy.sunrise}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-2 rounded-3 bg-light border text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Sunset"]</span>
                                <span class="fw-bold small text-danger"><i class="bi bi-sunset me-1"></i>${astronomy.sunset}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-primary bg-opacity-10 border border-primary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["UV Index"]</span>
                                <span class="fw-bold small text-primary">${current?.uvIndex || '0'}</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-info bg-opacity-10 border border-info border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Pressure"]</span>
                                <span class="fw-bold small text-info">${current?.pressure || '--'} hPa</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 rounded-3 bg-success bg-opacity-10 border border-success border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Humidity"]</span>
                                <span class="fw-bold small text-success">${current?.humidity || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Rain Chance"]</span>
                                <span class="fw-bold small text-warning-emphasis"><i class="bi bi-cloud-rain me-1"></i>${chanceOfRain}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 rounded-3 bg-secondary bg-opacity-10 border border-secondary border-opacity-10 text-center h-100">
                                <span class="d-block smaller text-muted">@Localizer["Cloud Cover"]</span>
                                <span class="fw-bold small text-secondary-emphasis"><i class="bi bi-clouds me-1"></i>${current?.cloudcover || '0'}%</span>
                            </div>
                        </div>
                    </div>

                    <a href="https://www.google.com/maps/search/${encodeURIComponent(fullLocation)}" 
                       target="_blank" 
                       class="location-info p-2 rounded-pill bg-light mb-3 mx-auto d-inline-block px-4 text-decoration-none text-dark hover-link border"
                       title="@Localizer["View on Google Maps"]">
                        <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                        <span class="fw-medium">${fullLocation}</span>
                    </a>
                    
                    <div class="d-flex justify-content-between px-3 py-2 border-top mt-2">
                        <div class="text-center">
                            <i class="bi bi-thermometer-low text-primary d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.mintempC || '--'}째C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-thermometer-high text-danger d-block"></i>
                            <span class="smaller fw-bold">${weatherToday?.maxtempC || '--'}째C</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-wind text-secondary d-block"></i>
                            <span class="smaller fw-bold">${current?.windspeedKmph || '0'} @Localizer["km/h"]</span>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-eye-fill text-warning d-block"></i>
                            <span class="smaller fw-bold">${current?.visibility || '0'} @Localizer["km"]</span>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="smaller text-muted" style="font-size: 0.7rem;">
                            <i class="bi bi-arrow-repeat me-1"></i>@Localizer["Last updated:"] ${lastUpdated}
                        </span>
                    </div>
                `;
                // Trigger translation for the weather card content
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(content);
                }
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-danger py-3 px-3 small rounded-4 mx-2 text-center shadow-sm">
                        <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                        <p class="mb-2">@Localizer["Could not load weather for"] "${location}".</p>
                        <button onclick="fetchWeather('${location}')" class="btn btn-danger btn-sm rounded-pill px-4">
                            <i class="bi bi-arrow-clockwise me-1"></i> @Localizer["Retry"]
                        </button>
                    </div>
                `;
                console.error('Weather error:', error);
            }
        }

        function updateWeather() {
            const location = document.getElementById('location-input').value.trim();
            fetchWeather(location);
        }

        // --- Currency Logic ---
        let currencyInfoMap = {};

        async function initCurrencies() {
            try {
                // Fetch exchange rates and country info in parallel
                const [rateRes, countryRes] = await Promise.all([
                    fetch('https://open.er-api.com/v6/latest/USD'),
                    fetch('https://restcountries.com/v3.1/all?fields=name,currencies,flags,cca2')
                ]);

                const rateData = await rateRes.json();
                const countryData = await countryRes.json();
                
                if (rateData.result === "success") {
                    let currencyOptions = [];

                    // Process country data
                    countryData.forEach(country => {
                        if (country.currencies) {
                            Object.entries(country.currencies).forEach(([code, details]) => {
                                // Include all countries, even if rate is missing
                                currencyOptions.push({
                                    countryName: country.name.common,
                                    countryCode: country.cca2,
                                    currencyCode: code,
                                    currencyName: details.name,
                                    flag: country.flags.svg,
                                    // Unique value for select option to prevent jumping
                                    value: `${code}|${country.cca2}`
                                });

                                // Store info for display
                                currencyInfoMap[`${code}|${country.cca2}`] = {
                                    name: details.name,
                                    symbol: details.symbol,
                                    flag: country.flags.svg,
                                    country: country.name.common
                                };
                            });
                        }
                    });

                    // Sort by country name
                    currencyOptions.sort((a, b) => a.countryName.localeCompare(b.countryName));

                    const fromSelect = document.getElementById('from-currency');
                    const toSelect = document.getElementById('to-currency');
                    
                    const populateSelect = (select, defaultCountryCode, defaultCurrencyCode) => {
                        select.innerHTML = '';
                        let defaultFound = false;
                        
                        currencyOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.text = `${opt.countryName} - ${opt.currencyName} (${opt.currencyCode})`;
                            select.appendChild(option);

                            // auto-select defaults (US for USD, IN for INR)
                            if (!defaultFound && opt.countryCode === defaultCountryCode && opt.currencyCode === defaultCurrencyCode) {
                                select.value = opt.value;
                                defaultFound = true;
                            }
                        });
                    };

                    populateSelect(fromSelect, 'US', 'USD');
                    populateSelect(toSelect, 'IN', 'INR');
                }
            } catch (error) {
                console.error('Failed to load currencies:', error);
            }
        }

        async function convertCurrency() {
            const amountInput = document.getElementById('amount');
            const amount = amountInput.value || 1;
            // Value format is "CODE|COUNTRY_CODE"
            const fromValue = document.getElementById('from-currency').value;
            const toValue = document.getElementById('to-currency').value;
            
            if (!fromValue || !toValue) return;

            const fromCode = fromValue.split('|')[0];
            const toCode = toValue.split('|')[0];
            
            const resDiv = document.getElementById('currency-result');

            resDiv.innerHTML = `
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                    <span class="small text-muted">@Localizer["Calculating..."]</span>
                </div>
            `;

            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${fromCode}`);
                const data = await response.json();
                
                if (data.result === "success") {
                    const rate = data.rates[toCode];
                    
                    if (rate !== undefined) {
                        const converted = (amount * rate).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        
                        const fromInfo = currencyInfoMap[fromValue];
                        const toInfo = currencyInfoMap[toValue];

                        const symbol = (toInfo.symbol && toInfo.symbol !== 'undefined') ? toInfo.symbol : '';
                        const currencyName = toInfo.currencyName || '';
                        const countryName = toInfo.country || '';
                        
                        resDiv.innerHTML = `
                            <div class="text-start">
                                <div class="small text-muted mb-1">
                                    <img src="${fromInfo.flag}" class="flag-icon me-1" style="width: 20px; height: 15px; vertical-align: middle;">
                                    ${amount} ${fromInfo.country} (${fromCode}) @Localizer["equals"]
                                </div>
                                <div class="h3 fw-bold mb-0">
                                    <img src="${toInfo.flag}" class="flag-icon me-1" style="width: 30px; height: 22px; vertical-align: baseline;">
                                    ${symbol} ${converted} 
                                </div>
                                <div class="fw-medium text-dark small">${currencyName}</div>
                                <div class="small text-muted">@Localizer["in"] ${countryName}</div>
                            </div>
                        `;
                        // Trigger translation for currency result
                        if (window.TranslationManager) {
                            window.TranslationManager.translateElement(resDiv);
                        }
                    } else {
                        resDiv.innerHTML = '<div class="text-warning small text-center"><i class="bi bi-exclamation-circle me-1"></i> @Localizer["Exchange rate unavailable"]</div>';
                        console.warn(`Rate not found for ${toCode}`);
                    }
                } else {
                    resDiv.innerHTML = ''; // Silently fail
                    console.warn('Error fetching rates');
                }
            } catch (error) {
                resDiv.innerHTML = ''; // Silently fail
                console.error('Currency error:', error);
            }
        }

        // --- Time Logic ---
        let currentTargetTimezone = 'UTC';
        let currentTargetLocationName = 'UTC (GMT)';
        const searchCache = new Map(); // Cache for search results

        let searchTimeout;
        async function handleGlobalSearch() {
            const query = document.getElementById('timezone-search').value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 3) {
                resultsDiv.classList.add('d-none');
                return;
            }

            // Check Cache
            if (searchCache.has(query.toLowerCase())) {
                renderSearchResults(searchCache.get(query.toLowerCase()));
                return;
            }

            // Debounce
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    // Single API call for Location + Timezone
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`);
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = '<div class="list-group-item small text-muted text-center py-3">@Localizer["No location found"]</div>';
                        resultsDiv.classList.remove('d-none');
                        return;
                    }

                    // Cache results
                    searchCache.set(query.toLowerCase(), data.results);
                    renderSearchResults(data.results);

                } catch (error) {
                    console.error('Geo search error:', error);
                }
            }, 300); 
        }

        function renderSearchResults(results) {
            const resultsDiv = document.getElementById('search-results');
            const input = document.getElementById('timezone-search');
            
            // --- Auto-select first result (Optimistic) ---
            const first = results[0];
            updateTimezoneFromData(first, false); // Don't update input text yet

            // --- Populate dropdown ---
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('d-none');
            
            results.forEach(item => {
                const name = item.name;
                const country = item.country || '';
                const admin1 = item.admin1 || '';
                const details = [admin1, country].filter(x => x && x !== name).join(', ');
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action small py-2 px-3 border-0';
                btn.innerHTML = `
                    <div class="fw-bold text-start">${name}</div>
                    <div class="smaller text-muted text-start">${details}</div>
                `;
                
                btn.onclick = () => {
                    resultsDiv.classList.add('d-none');
                    input.value = `${name}, ${country}`;
                    updateTimezoneFromData(item, true);
                };
                resultsDiv.appendChild(btn);
            });
            
            // Trigger translation for search results
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(resultsDiv);
            }
        }

        function updateTimezoneFromData(item, updateLabel) {
            if (item.timezone) {
                currentTargetTimezone = item.timezone;
                currentTargetLocationName = `${item.name}, ${item.country || ''}`;
                updateTargetTime();
            }
        }



        function getCurrentCulture() {
            // Prefer TranslationManager's language if available, else fallback to server culture
            if (window.TranslationManager && window.TranslationManager.currentLang) {
                // Formatting needs full locale sometimes, but 'es', 'fr' etc usually work for Date
                return window.TranslationManager.currentLang; 
            }
            return window.APP_CULTURE || 'en-US';
        }

        function updateTimes() {
            const now = new Date();
            const culture = getCurrentCulture();
            document.getElementById('local-time').innerText = now.toLocaleTimeString(culture, { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true 
            });
            updateTargetTime();
        }

        function updateTargetTime() {
            const timezone = currentTargetTimezone;
            const targetTimeDiv = document.getElementById('target-time');
            const targetDateDiv = document.getElementById('target-date');
            const relativeDayDiv = document.getElementById('relative-day');
            const locationDisplay = document.getElementById('target-location-display');

            if (locationDisplay) locationDisplay.innerText = currentTargetLocationName;

            if (!timezone) {
                // ... (fallback)
                return;
            }

            const now = new Date();
            const culture = getCurrentCulture();
            try {
                // Time
                const targetTimeStr = now.toLocaleTimeString(culture, { 
                    timeZone: timezone, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    hour12: true
                });
                targetTimeDiv.innerText = targetTimeStr;

                // Date
                const options = { timeZone: timezone, weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                const targetDateStr = now.toLocaleDateString(culture, options);
                targetDateDiv.innerText = targetDateStr;

                // Relative Day logic
                const localDateStr = now.toLocaleDateString('en-US'); // Keep calculation logic stable in EN
                const targetDateSimpleStr = now.toLocaleDateString('en-US', { timeZone: timezone });
                
                const localDate = new Date(localDateStr);
                const targetDate = new Date(targetDateSimpleStr);
                
                const diffTime = targetDate - localDate;
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                relativeDayDiv.className = 'badge rounded-pill mt-2';
                let dayText = "";
                if (diffDays === 0) {
                    relativeDayDiv.innerText = "";
                } else if (diffDays > 0) {
                    dayText = "@Localizer["Tomorrow"]";
                    relativeDayDiv.classList.add('badge-tomorrow');
                } else { // diffDays < 0
                    dayText = "@Localizer["Yesterday"]";
                    relativeDayDiv.classList.add('badge-yesterday');
                }
                
                if(dayText) {
                    relativeDayDiv.innerText = dayText;
                    // Trigger dynamic translation only for the relative day badge text
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(relativeDayDiv);
                    }
                }

            } catch (e) {
                targetTimeDiv.innerText = "@Localizer["Error"]";
                targetDateDiv.innerText = "";
                relativeDayDiv.innerText = "";
            }
        }




        // --- News Logic ---
        async function fetchNews(query = '', country = '') {
            if (!country) {
                country = document.getElementById('news-country-select')?.value || 'in';
            }
            const container = document.getElementById('news-container');
            
            // Show loading state
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
            
            try {
                // Using the new GetCityNews for real-time trusted sources
                let url = `/News/GetCityNews?city=${encodeURIComponent(query)}&country=${encodeURIComponent(country)}`;

                const response = await fetch(url); 
                const data = await response.json();
                
                if (data.status === 'ok' && data.articles) {
                    container.innerHTML = '';
                    const articles = data.articles.filter(a => a.title && a.urlToImage).slice(0, 5);
                    
                    if (articles.length === 0) {
                        container.innerHTML = `<p class="small text-muted text-center">@Localizer["No recent news found."]</p>`;
                        return;
                    }

                    let carouselHtml = `
                        <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel" style="width: 100%;">
                            <div class="carousel-inner rounded-3 overflow-hidden">
                    `;

                    articles.forEach((article, index) => {
                        const imgUrl = article.urlToImage || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop';
                        const date = new Date(article.publishedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                        
                        carouselHtml += `
                            <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                <div class="position-relative">
                                    <img src="${imgUrl}" class="d-block w-100 object-fit-cover" alt="News" style="height: 160px;" onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=640&auto=format&fit=crop'">
                                    <div class="position-absolute bottom-0 start-0 w-100 p-2 text-white" style="background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);">
                                        <span class="badge bg-danger shadow-sm" style="font-size: 0.6rem;">${article.source.name}</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <h6 class="fw-bold mb-1 line-clamp-2" style="font-size: 0.85rem;">
                                        <a href="${article.url}" target="_blank" class="text-dark text-decoration-none stretched-link">${article.title}</a>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="smaller text-muted">${date}</span>
                                        <span class="badge bg-light text-warning smaller shadow-none border py-0 px-1" style="font-size: 0.6rem;">LIVE</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    carouselHtml += `</div></div>`;
                    container.innerHTML = carouselHtml;
                    
                    // Trigger translation for news container
                    if (window.TranslationManager) {
                        window.TranslationManager.translateElement(container);
                    }
                }
            } catch (error) {
                console.error('News error:', error);
                container.innerHTML = `<p class="small text-muted text-center">@Localizer["Unable to load news."]</p>`;
            }
        }

        function searchNews() {
            const query = document.getElementById('news-search-input').value.trim();
            const countrySelect = document.getElementById('news-country-select');
            const countryName = countrySelect.options[countrySelect.selectedIndex].text;
            
            if (query) {
                // Redirect to the dedicated City News page with both parameters
                window.location.href = `/News/CityNews?city=${encodeURIComponent(query)}&country=${encodeURIComponent(countryName)}`;
            } else {
                // If query is empty, just refresh the widget with the selected country
                fetchNews('', countrySelect.value);
            }
        }

        async function saveNewNote() {
            const text = document.getElementById('new-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/AddNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Add note error:', error);
            }
        }

        function openEditModal(id, text) {
            document.getElementById('edit-note-id').value = id;
            document.getElementById('edit-note-text').value = text;
            const modal = new bootstrap.Modal(document.getElementById('editNoteModal'));
            modal.show();
        }

        async function updateNote() {
            const id = document.getElementById('edit-note-id').value;
            const text = document.getElementById('edit-note-text').value;
            if (!text.trim()) return;

            try {
                const response = await fetch('/Dashboard/EditNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}&text=${encodeURIComponent(text)}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Update note error:', error);
            }
        }

        // --- World Countries logic ---
        let allCountries = [];

        async function fetchAllCountries() {
            const container = document.getElementById('country-container');
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,translations');
                if (!response.ok) throw new Error('API failed');
                allCountries = await response.json();
                
                 // Helper to get name in current language
                allCountries.forEach(c => {
                    c.displayName = getTranslatedCountryName(c);
                });

                // Sort alphabetically
                allCountries.sort((a, b) => a.displayName.localeCompare(b.displayName));
                
                renderCountryList(allCountries);
            } catch (error) {
                console.error('Fetch all countries error:', error);
                if (container) container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('ErrorLoadDir')}</div>`;
            }
        }
        
        
        const uiLabels = {
            'en': { 'Capital': 'Capital', 'Population': 'Population', 'Currency': 'Currency', 'Timezone': 'Timezone', 'Language': 'Language', 'Loading': 'Loading...', 'Back': 'Back', 'NA': 'N/A', 'SearchPlaceholder': 'Search country...', 'NoResults': 'No results found.', 'ErrorLoadDir': 'Unable to load directory.', 'ErrorLoadDetails': 'Unable to load details.' },
            'hi': { 'Capital': '西겯ㅎ西西㏅ㅎ西ⓣ', 'Population': '西西ⓣㅈ西西誓西西', 'Currency': '西誓西╆西겯ㅎ', 'Timezone': '西멘ㄾ西 西誓西룅西ㅰ西', 'Language': '西西약ㅇ西', 'Loading': '西꿋西 西밝 西겯ㅉ西 西밝...', 'Back': '西듀ㅎ西むㅈ', 'NA': '西꿋ㅎ西誓 西ⓣㅉ誓西', 'SearchPlaceholder': '西╆西 西誓西誓西...', 'NoResults': '西誓西 西むㅀ西욈ㄳ西약ㄾ 西ⓣㅉ誓西 西西욈ㅂ西약ⅳ', 'ErrorLoadDir': '西ⓣㅏ西겯西╆西뜩ㅏ西西 西꿋西 西西겯ㄸ誓 西誓西 西西멘ㄾ西겯西誓', 'ErrorLoadDetails': '西듀ㅏ西듀ㅀ西 西꿋西 西西겯ㄸ誓 西誓西 西西멘ㄾ西겯西誓' },
            'gu': { 'Capital': '夕むぞ夕夕ⓣ夕', 'Population': '夕듀じ奭夕ㅰ', 'Currency': '夕夕꿋ぃ', 'Timezone': '夕멘ぎ夕 夕奭夕룅夕ㅰ夕', 'Language': '夕夕약し夕', 'Loading': '夕꿋夕 夕夕 夕겯す奭夕奭夕 夕奭...', 'Back': '夕むぞ夕夕', 'NA': '夕꿋ぞ夕奭 夕ⓣぅ奭', 'SearchPlaceholder': '夕╆夕 夕뜩夕㏅...', 'NoResults': '夕奭夕 夕むぐ夕욈ぃ夕약ぎ奭 夕夕녀夕夕 夕ⓣぅ奭.', 'ErrorLoadDir': '夕□た夕겯夕奭夕夕겯 夕꿋夕 夕夕겯さ夕약ぎ夕약 夕夕멘ぎ夕겯夕.', 'ErrorLoadDetails': '夕듀た夕夕ㅰ 夕꿋夕 夕夕겯さ夕약ぎ夕약 夕夕멘ぎ夕겯夕.' },
            'bn': { 'Capital': '逝겯┥逝逝㏅┥逝ⓣ', 'Population': '逝逝ⓣ┯逝逝鋤逝逝', 'Currency': '逝鋤逝╆逝겯┥', 'Timezone': '逝멘┏逝逝 逝逝鋤逝逝', 'Language': '逝逝약┠逝', 'Loading': '逝꿋逝 逝밝鋤逝鋤...', 'Back': '逝ム┸逝겯 逝逝약┬', 'NA': '逝む逝겯┓鋤逝鋤逝 逝ⓣ┓逝', 'SearchPlaceholder': '逝╆逝 逝鋤逝逝鋤逝...', 'NoResults': '逝鋤逝 逝ム┣逝약┼逝 逝む┥逝逝逝솰┥ 逝逝약┓逝솰┬逝욈ⅳ', 'ErrorLoadDir': '逝□┸逝겯逝鋤逝逝겯┸ 逝꿋逝 逝逝겯┐鋤 逝逝鋤逝룅┏誓', 'ErrorLoadDetails': '逝о┸逝о┛逝 逝꿋逝 逝逝겯┐鋤 逝逝鋤逝룅┏誓' },
            'te': { 'Capital': '析겯갼析析㏅갼析ⓣ걀', 'Population': '析析ⓣ갼析析', 'Currency': '析析겯析ⓣ析멘', 'Timezone': '析멘갖析 析析析□갛析', 'Language': '析析약갬', 'Loading': '析꿋析□ 析析듀析ㅰ析析╆걀...', 'Back': '析듀析ⓣ析析汐', 'NA': '析듀같汐析ㅰ걀析析析╆', 'SearchPlaceholder': '析╆析뜩갼析ⓣ析ⓣ걀 析듀析ㅰ析析□걀...', 'NoResults': '析ム갛析욈갇析약갛汐 析析ⓣ析汐析ⓣ갔析□갛汐析╆.', 'ErrorLoadDir': '析□析겯析汐析析겯析ⓣ걀 析꿋析□ 析汐析析꿋析析む析析욈析╆걀.', 'ErrorLoadDetails': '析듀걀析듀같析약갛析ⓣ 析꿋析□ 析汐析析꿋析析む析析욈析╆걀.' },
            'ta': { 'Capital': '昔ㅰ꿋昔ⓣ昔겯晳', 'Population': '昔昔晳昔昔녀 昔ㅰ昔晳', 'Currency': '昔ⓣ약｀昔晳', 'Timezone': '昔ⓣ昔 昔昔｀昔昔꿋晳', 'Language': '昔晳昔닮', 'Loading': '昔昔긍昔긍む昔む晳昔昔욈긍ㅰ...', 'Back': '昔む욈⒯昔⒯약꿋', 'NA': '昔む昔겯昔ⓣ昔ㅰ약ㅰ', 'SearchPlaceholder': '昔ⓣ약晳昔晳昔ㅰ 昔ㅰ昔晳昔晳昔昔녀...', 'NoResults': '昔晳昔昔욈듀昔昔녀 昔昔ㅰ昔듀昔晳 昔昔약｀む昔む昔듀욈꿋昔꿋.', 'ErrorLoadDir': '昔昔晳昔듀 昔昔긍昔 昔晳昔昔욈昔듀욈꿋昔꿋.', 'ErrorLoadDetails': '昔듀욈듀겯晳昔昔녀 昔昔긍昔 昔晳昔昔욈昔듀욈꿋昔꿋.' },
            'mr': { 'Capital': '西겯ㅎ西西㏅ㅎ西ⓣ', 'Population': '西꿋西西멘西誓西西', 'Currency': '西西꿋ㄸ', 'Timezone': '西듀西 西誓西룅西ㅰ西', 'Language': '西西약ㅇ西', 'Loading': '西꿋西 西밝西 西西밝...', 'Back': '西西약誓', 'NA': '西꿋ㅎ西誓 西ⓣㅎ西밝', 'SearchPlaceholder': '西╆西 西뜩西㏅ㅎ...', 'NoResults': '西西약ㅉ誓西밝 西멘ㅎ西むㄱ西꿋 西ⓣㅎ西밝.', 'ErrorLoadDir': '西ⓣㅏ西겯西╆西뜩ㅏ西西 西꿋西 西西겯ㄳ誓西西약ㄴ 西西誓西룅ㄾ.', 'ErrorLoadDetails': '西ㅰㄺ西뜩西 西꿋西 西西겯ㄳ誓西西약ㄴ 西西誓西룅ㄾ.' },
            'kn': { 'Capital': '淅겯꼐淅淅㏅꼐淅ⓣ꼬', 'Population': '淅淅ⓣ껴淅淅潟淅潟', 'Currency': '淅淅겯淅ⓣ淅멘꼬', 'Timezone': '淅멘껍淅 淅듀께淅', 'Language': '淅淅약껭潟', 'Loading': '淅꿋淅□ 淅淅潟淅ㅰ淅ㅰ꼬淅╆...', 'Back': '淅밝꼬淅淅╆', 'NA': '淅淅ⓣ淅듀껏淅욈껴潟淅듀淅╆꼬淅꿋淅', 'SearchPlaceholder': '淅╆淅뜩껨淅ⓣ淅ⓣ 淅밝淅□淅淅...', 'NoResults': '淅淅약껨潟淅╆ 淅ム께淅욈깽淅약淅뜩淅녀 淅淅淅□淅о淅╆꼬淅꿋淅.', 'ErrorLoadDir': '淅□淅겯淅潟淅淅겯꼬淅淅ⓣ淅ⓣ 淅꿋淅□ 淅淅약깹淅꿋 淅멘꼐淅㏅淅淅듀꼬淅꿋淅.', 'ErrorLoadDetails': '淅듀꼬淅듀껐淅淅녀꺼潟淅ⓣ 淅꿋淅□ 淅淅약깹淅꿋 淅멘꼐淅㏅淅淅듀꼬淅꿋淅.' },
            'ml': { 'Capital': '石ㅰ눠石멘石石약뇽石', 'Population': '石石ⓣ뉨石石碩石', 'Currency': '石石긍돐石멘늉', 'Timezone': '石멘눔石 石碩石石', 'Language': '石石약뉠', 'Loading': '石꿋石□石碩石碩石碩石ⓣ石ⓣ...', 'Back': '石ㅰ늉石겯늉石碩', 'NA': '石о늅石㏅石石꿋石', 'SearchPlaceholder': '石겯늅石碩石石 石ㅰ늉石겯눕碩石...', 'NoResults': '石ム눠石碩石石녀石ⓣ石ⓣ石 石石｀石碩石ㅰ石ㅰ늉石石욈눠碩石.', 'ErrorLoadDir': '石□눕石긍碩石石긍늉 石꿋石□石碩石碩石碩石ⓣ石ⓣ뇬石욈뇽碩 石石닮늉石碩石石욈눠碩石.', 'ErrorLoadDetails': '石듀늉石뜩뇹石약石뜩碩石碩 石꿋石□石碩石碩石碩石ⓣ石ⓣ뇬石욈뇽碩 石石닮늉石碩石石욈눠碩石.' },
            'pa': { 'Capital': '黍겯㉭黍黍㏅㉭黍ⓣ', 'Population': '黍黍о㉭黍╆', 'Currency': '黍鼠黍╆겯㉭', 'Timezone': '黍멘Ŧ黍약 黍鼠黍ㅰ', 'Language': '黍黍약㉧黍솰㉭', 'Loading': '黍꿋黍 黍밝 黍겯㉮黍밝㉭ 黍밝...', 'Back': '黍듀㉭黍む㉧', 'NA': '黍꿋㉭黍鼠 黍ⓣ㉨鼠黍', 'SearchPlaceholder': '黍╆黍멘㉫ 黍鼠黍鼠...', 'NoResults': '黍鼠黍 黍ⓣĦ鼠黍黍 黍ⓣ㉨鼠黍 黍黍욈㉡黍욈誓', 'ErrorLoadDir': '黍□㉭黍黍겯黍黍黍겯 黍꿋黍 黍黍겯Ŀ 黍듀㉮鼠긍 黍黍멘Ŧ黍겯㈀黍誓', 'ErrorLoadDetails': '黍듀黍겯㉤鼠 黍꿋黍 黍黍겯Ŀ 黍듀㉮鼠긍 黍黍멘Ŧ黍겯㈀黍誓' },
            'ur': { 'Capital': '膜碼邈碼幕沕魔', 'Population': '笠磨碼膜', 'Currency': '沕邈卍', 'Timezone': '摹碼痲 万', 'Language': '万磨碼', 'Loading': '  邈碼 ...', 'Back': '碼毛卍', 'NA': '碼彌 謎', 'SearchPlaceholder': '沕 魔碼娩 沕邈謎...', 'NoResults': '沕痲 魔碼痲寞 謎 ', 'ErrorLoadDir': '碼痲邈沕摹邈  沕邈 卍 碼巒邈', 'ErrorLoadDetails': '魔巒碼魔  沕邈 卍 碼巒邈' }
        };

        function getUiLabel(key) {
            const culture = window.APP_CULTURE || 'en-US';
            const langCode = culture.split('-')[0];
            const labels = uiLabels[langCode] || uiLabels['en'];
            return labels[key] || key;
        }

        function getTranslatedCountryName(country) {
            const culture = window.APP_CULTURE || 'en-US';
            const langCode = culture.split('-')[0]; // e.g., 'hi' from 'hi-IN'
            
            // Map ISO 639-1 (2 char) to RestCountries translation keys (3 char mostly)
            const langMap = {
                'hi': 'hin', 'gu': 'guj', 'bn': 'ben', 'ta': 'tam', 
                'te': 'tel', 'kn': 'kan', 'ml': 'mal', 'mr': 'mar', 
                'pa': 'pan', 'ur': 'urd', 'fr': 'fra', 'es': 'spa',
                'de': 'deu', 'it': 'ita', 'pt': 'por', 'ru': 'rus',
                'ja': 'jpn', 'zh': 'zho', 'ar': 'ara'
            };
            
            const trKey = langMap[langCode];
            if (trKey && country.translations && country.translations[trKey]) {
                return country.translations[trKey].common;
            }
            return country.name.common;
        }

        function renderCountryList(list) {
            const container = document.getElementById('country-container');
            const searchIcon = document.getElementById('country-search-icon');
            
            // Set icon to search by default
            const searchInput = document.getElementById('country-search-input');
            if (searchInput) {
                searchInput.placeholder = getUiLabel('SearchPlaceholder');
            }

            if (searchIcon) {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null; // Reset to default if it was "X"
            }

            if (list.length === 0) {
                container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('NoResults')}</div>`;
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            list.forEach(c => {
                html += `
                    <button type="button" class="list-group-item list-group-item-action d-flex align-items-center bg-transparent border-0 py-2 px-1" onclick="showCountryDetail('${c.cca3}')">
                        <img src="${c.flags.svg}" class="rounded-1 me-3 shadow-sm" style="width: 30px; height: 20px; object-fit: cover;">
                        <span class="small fw-medium">${c.displayName}</span>
                        <i class="bi bi-chevron-right ms-auto smaller text-muted opacity-50"></i>
                    </button>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            // Trigger translation for country list
            if (window.TranslationManager) {
                window.TranslationManager.translateElement(container);
            }
        }

        function filterCountries(query) {
            const searchIcon = document.getElementById('country-search-icon');
            if (query.trim()) {
                searchIcon.className = 'bi bi-x-lg';
                searchIcon.parentElement.onclick = showCountryList;
            } else {
                searchIcon.className = 'bi bi-search';
                searchIcon.parentElement.onclick = null;
            }

            const filtered = allCountries.filter(c => 
                c.displayName.toLowerCase().includes(query.toLowerCase())
            );
            renderCountryList(filtered);
        }

        function showCountryList() {
            document.getElementById('country-search-input').value = '';
            renderCountryList(allCountries);
        }

        async function showCountryDetail(cca3) {
            const container = document.getElementById('country-container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-info spinner-border-sm" role="status" style="color: #6610f2 !important;">
                        <span class="visually-hidden">${getUiLabel('Loading')}</span>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`https://restcountries.com/v3.1/alpha/${cca3}`);
                if (!response.ok) throw new Error('Details not found');
                const data = await response.json();
                const country = data[0];

                const name = getTranslatedCountryName(country);
                const flag = country.flags.svg;
                const capital = country.capital ? country.capital[0] : getUiLabel('NA');
                const region = country.region;
                const population = country.population.toLocaleString(window.APP_CULTURE);
                const currencies = country.currencies ? Object.values(country.currencies).map(c => `${c.name} (${c.symbol})`).join(', ') : getUiLabel('NA');
                const languages = country.languages ? Object.values(country.languages).join(', ') : getUiLabel('NA');
                const timezones = country.timezones ? country.timezones[0] : getUiLabel('NA');

                container.innerHTML = `
                    <div class="country-details mt-2">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" onclick="showCountryList()" style="font-size: 0.7rem;">
                                <i class="bi bi-arrow-left me-1"></i> ${getUiLabel('Back')}
                            </button>
                        </div>
                        <div class="text-center mb-3">
                            <img src="${flag}" class="shadow-sm rounded-3" style="width: 100%; max-height: 120px; object-fit: cover; border: 1px solid #eee;">
                            <h5 class="fw-bold mt-2 mb-0">${name}</h5>
                            <span class="badge bg-light text-dark border smaller">${region}</span>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Capital')}</span>
                                    <span class="fw-bold small text-dark">${capital}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Population')}</span>
                                    <span class="fw-bold small text-dark">${population}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Currency')}</span>
                                    <span class="fw-bold small text-dark" style="font-size: 0.65rem;">${currencies}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-2 rounded-3 bg-light border text-center h-100">
                                    <span class="d-block smaller text-muted">${getUiLabel('Timezone')}</span>
                                    <span class="fw-bold small text-dark">${timezones}</span>
                                </div>
                            </div>
                            <div class="col-12 mt-1">
                                <div class="p-2 rounded-3 bg-light border text-center">
                                    <span class="d-block smaller text-muted">${getUiLabel('Language')}</span>
                                    <span class="fw-bold small text-dark">${languages}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.scrollTop = 0; // Reset scroll
                // Trigger translation for country details
                if (window.TranslationManager) {
                    window.TranslationManager.translateElement(container);
                }
            } catch (error) {
                console.error('Country details error:', error);
                container.innerHTML = `<div class="text-center py-5 text-muted small">${getUiLabel('ErrorLoadDetails')}</div>`;
            }
        }


        async function deleteNote(id) {
            if (!confirm('@Localizer["Are you sure you want to delete this note?"]')) return;

            try {
                const response = await fetch('/Dashboard/DeleteNote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Delete note error:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            detectLocationAndFetchWeather(); // Detect and fetch
            initCurrencies();
            // initTimezones(); REMOVED
            window.timeUpdateInterval = setInterval(updateTimes, 1000);
            
            // Auto-refresh weather every 10 minutes ONLY if we have a location
            if (window.weatherRefreshInterval) clearInterval(window.weatherRefreshInterval);
            window.weatherRefreshInterval = setInterval(() => {
                const currentLoc = document.querySelector('.location-info .fw-medium')?.innerText;
                if (currentLoc) {
                    // Refresh current displayed location
                    fetchWeather(currentLoc);
                } else {
                    // Try to re-detect if nothing is shown
                    detectLocationAndFetchWeather();
                }
            }, 10 * 60 * 1000);
            
            updateTimes();
            // Initial conversion delayed slightly to allow currencies to load
            setTimeout(convertCurrency, 1000);
            
            fetchNews();
            fetchAllCountries();
        });
    </script>
}
